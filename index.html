<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’µ å­˜é’±å°å·¥å…·</title>
<meta name="theme-color" content="#1b5e20">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
/* ============================================
   ğŸ¨ å­˜é’±å°å·¥å…· v11.0 - ç¾å­¦å‡çº§ç‰ˆ
   ============================================ */

/* CSS å˜é‡ - ä¸»é¢˜è‰²å½©ç³»ç»Ÿ */
:root {
  --primary: #1b5e20;
  --primary-dark: #0d3312;
  --primary-light: #4caf50;
  --accent: #ffd700;
  --accent-light: #ffeb3b;
  --bg-gradient: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #388e3c 100%);
  --glass: rgba(255, 255, 255, 0.15);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.1);
  --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.15);
  --shadow-strong: 0 12px 40px rgba(0, 0, 0, 0.2);
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* åŸºç¡€é‡ç½® */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--bg-gradient);
  background-attachment: fixed;
  min-height: 100vh;
  color: #333;
  line-height: 1.6;
  overflow-x: hidden;
}

/* åŠ¨æ€èƒŒæ™¯ç²’å­ */
.bg-particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}

.particle {
  position: absolute;
  width: 6px;
  height: 6px;
  background: var(--accent);
  border-radius: 50%;
  opacity: 0.3;
  animation: float 20s infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
  10% { opacity: 0.3; }
  90% { opacity: 0.3; }
  100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
}

/* å®¹å™¨ */
.container {
  position: relative;
  z-index: 1;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  padding-bottom: 100px;
}

/* å¤´éƒ¨åŒºåŸŸ - ç»ç’ƒæ‹Ÿæ€ */
.header {
  text-align: center;
  padding: 30px 20px;
  margin-bottom: 20px;
}

.header h1 {
  color: white;
  font-size: 2.2rem;
  font-weight: 700;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}

.header-subtitle {
  color: rgba(255,255,255,0.8);
  font-size: 0.95rem;
}

/* çŠ¶æ€æ  - ç»ç’ƒå¡ç‰‡ */
.status-bar {
  background: var(--glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  padding: 12px 20px;
  border-radius: var(--radius-xl);
  margin-bottom: 20px;
  color: white;
  font-size: 0.85rem;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all var(--transition-normal);
  animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.status-bar.online {
  background: rgba(76, 175, 80, 0.3);
  border-color: rgba(76, 175, 80, 0.5);
}

.status-bar.offline {
  background: rgba(255, 100, 100, 0.3);
  border-color: rgba(255, 100, 100, 0.5);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ç”¨æˆ·ä¿¡æ¯æ  */
.user-bar {
  background: var(--glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  padding: 15px 25px;
  border-radius: var(--radius-xl);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
  animation: slideUp 0.6s ease-out 0.1s both;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  background: var(--accent);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: var(--shadow-soft);
}

.user-name {
  font-weight: 600;
}

.user-name span {
  color: var(--accent);
  font-weight: 700;
}

.user-actions {
  display: flex;
  gap: 10px;
}

.btn-icon {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: var(--radius-lg);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-icon:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}

/* ç»Ÿè®¡å¡ç‰‡ - ç»ç’ƒæ‹Ÿæ€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 20px;
  animation: slideUp 0.6s ease-out 0.2s both;
}

.stat-card {
  background: var(--glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  padding: 25px 20px;
  border-radius: var(--radius-lg);
  text-align: center;
  color: white;
  transition: all var(--transition-normal);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  transform: scaleX(0);
  transition: transform var(--transition-normal);
}

.stat-card:hover::before {
  transform: scaleX(1);
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-medium);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, white, var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.85rem;
  opacity: 0.8;
}

/* ç»ç’ƒå¡ç‰‡é€šç”¨æ ·å¼ */
.glass-card {
  background: white;
  border-radius: var(--radius-lg);
  padding: 25px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-soft);
  animation: slideUp 0.6s ease-out 0.3s both;
  transition: all var(--transition-normal);
}

.glass-card:hover {
  box-shadow: var(--shadow-medium);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-title-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

/* è¡¨å•æ ·å¼ */
.form-group {
  margin-bottom: 18px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  color: #555;
  font-size: 0.9rem;
  font-weight: 500;
}

.form-input, .form-select {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid #e8e8e8;
  border-radius: var(--radius-md);
  font-size: 1rem;
  transition: all var(--transition-fast);
  background: #fafafa;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 4px rgba(27, 94, 32, 0.1);
}

.form-input::placeholder {
  color: #aaa;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: var(--radius-md);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}

.btn:active {
  transform: translateY(-1px);
}

.btn-gold {
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: var(--primary-dark);
}

.btn-outline {
  background: white;
  border: 2px solid var(--primary);
  color: var(--primary);
}

.btn-outline:hover {
  background: var(--primary);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #f44336, #e53935);
}

.btn-small {
  padding: 10px 18px;
  font-size: 0.9rem;
}

/* æ ‡ç­¾é¡µ */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  padding: 5px;
  background: #f5f5f5;
  border-radius: var(--radius-xl);
}

.tab {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: transparent;
  border-radius: var(--radius-lg);
  font-size: 0.9rem;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
}

.tab.active {
  background: white;
  color: var(--primary);
  box-shadow: var(--shadow-soft);
}

.tab:hover:not(.active) {
  color: #333;
}

/* è®¡åˆ’å¡ç‰‡ - ç²¾ç¾è®¾è®¡ */
.goal-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.goal-card {
  background: white;
  border-radius: var(--radius-lg);
  padding: 20px;
  box-shadow: var(--shadow-soft);
  transition: all var(--transition-normal);
  border-left: 4px solid transparent;
  position: relative;
  overflow: hidden;
}

.goal-card::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 100px;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,0,0,0.02));
  pointer-events: none;
}

.goal-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}

.goal-card.private {
  border-left-color: #2196F3;
}

.goal-card.family {
  border-left-color: #ff9800;
  background: linear-gradient(135deg, white, #fffde7);
}

.goal-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.goal-title {
  font-size: 1.15rem;
  font-weight: 700;
  color: #333;
}

.goal-badges {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.badge-private {
  background: #e3f2fd;
  color: #1976d2;
}

.badge-family {
  background: #fff3e0;
  color: #f57c00;
}

.badge-sync {
  background: #e8f5e9;
  color: #388e3c;
  animation: pulse 2s infinite;
}

/* æˆå‘˜å¤´åƒ */
.members {
  display: flex;
  gap: 8px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.member-avatar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  background: #f5f5f5;
  border-radius: 25px;
  font-size: 0.85rem;
  transition: all var(--transition-fast);
}

.member-avatar:hover {
  background: #e8e8e8;
}

.member-avatar.me {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
}

.member-avatar.owner {
  background: linear-gradient(135deg, #ff9800, #ffb74d);
  color: white;
}

/* è¿›åº¦æ¡ - åŠ¨ç”»æ•ˆæœ */
.progress-section {
  margin: 15px 0;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #666;
}

.progress-bar {
  height: 12px;
  background: #e8e8e8;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
  border-radius: 10px;
  transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ç»Ÿè®¡ç½‘æ ¼ */
.goal-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: var(--radius-md);
}

.stat-item {
  text-align: center;
}

.stat-item-value {
  font-size: 1rem;
  font-weight: 700;
  color: #333;
}

.stat-item-label {
  font-size: 0.75rem;
  color: #888;
  margin-top: 2px;
}

/* æ“ä½œæŒ‰é’®ç»„ */
.goal-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

/* è®°å½•åˆ—è¡¨ */
.record-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.record-item {
  display: flex;
  align-items: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
  border-left: 3px solid var(--primary-light);
}

.record-item:hover {
  background: #e8f5e9;
  transform: translateX(5px);
}

.record-icon {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  margin-right: 15px;
  flex-shrink: 0;
}

.record-content {
  flex: 1;
}

.record-amount {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--primary);
}

.record-meta {
  font-size: 0.85rem;
  color: #888;
  margin-top: 3px;
}

.record-date {
  font-size: 0.8rem;
  color: #aaa;
  text-align: right;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 50px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 1rem;
}

/* æ¨¡æ€æ¡† - ç»ç’ƒæ‹Ÿæ€ */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 450px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.4s ease-out;
  box-shadow: var(--shadow-strong);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 1px solid #e8e8e8;
}

.modal-title {
  font-size: 1.2rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  width: 36px;
  height: 36px;
  border: none;
  background: #f5f5f5;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  background: #e0e0e0;
  transform: rotate(90deg);
}

.modal-body {
  padding: 25px;
}

/* åˆ†äº«æ¡† */
.share-box {
  background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
  border: 2px dashed #ccc;
  border-radius: var(--radius-md);
  padding: 20px;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  word-break: break-all;
  margin: 15px 0;
  color: #555;
}

/* æµ®åŠ¨æ“ä½œæŒ‰é’® */
.fab {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  border: none;
  border-radius: 50%;
  font-size: 1.8rem;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
  transition: all var(--transition-normal);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
}

.fab:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 30px rgba(255, 215, 0, 0.6);
}

/* Toast æç¤º */
.toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #333;
  color: white;
  padding: 15px 25px;
  border-radius: var(--radius-xl);
  font-size: 0.95rem;
  z-index: 2000;
  opacity: 0;
  transition: all 0.3s ease;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ç‰ˆæœ¬æ ‡ç­¾ */
.version-tag {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.3);
  color: rgba(255, 255, 255, 0.7);
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 0.75rem;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* å“åº”å¼ */
@media (max-width: 480px) {
  .container {
    padding: 15px;
  }
  
  .header h1 {
    font-size: 1.8rem;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
  
  .goal-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .user-bar {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .fab {
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
  }
}

/* åŠ è½½åŠ¨ç”» */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* è®¾ç½®æŒ‡å— */
.setup-guide {
  background: linear-gradient(135deg, #fff3cd, #ffecb3);
  border: 1px solid #ffc107;
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
}

.setup-guide h3 {
  color: #856404;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.setup-guide ol {
  margin-left: 20px;
  color: #856404;
  font-size: 0.9rem;
  line-height: 1.8;
}

.setup-guide a {
  color: #1976d2;
  text-decoration: none;
}

.setup-guide a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<!-- èƒŒæ™¯ç²’å­æ•ˆæœ -->
<div class="bg-particles" id="bgParticles"></div>

<div class="container">
  <!-- å¤´éƒ¨ -->
  <header class="header">
    <h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
    <p class="header-subtitle">è®©å­˜é’±æˆä¸ºä¸€ç§äº«å—</p>
  </header>
  
  <!-- çŠ¶æ€æ  -->
  <div class="status-bar" id="statusBar">
    <span class="status-dot"></span>
    <span id="statusText">ğŸ”„ æ­£åœ¨è¿æ¥...</span>
  </div>
  
  <!-- è®¾ç½®æŒ‡å—ï¼ˆä»…æœªé…ç½®æ—¶æ˜¾ç¤ºï¼‰-->
  <div class="setup-guide" id="setupGuide" style="display:none">
    <h3>âš ï¸ éœ€è¦å¯ç”¨ Realtime Database</h3>
    <ol>
      <li>æ‰“å¼€ <a href="https://console.firebase.google.com/project/savingmoney-6d898/database" target="_blank">Firebase æ§åˆ¶å°</a></li>
      <li>ç‚¹å‡» "åˆ›å»ºæ•°æ®åº“"</li>
      <li>é€‰æ‹©åœ°åŒº "asia-southeast1"ï¼ˆæ–°åŠ å¡ï¼‰</li>
      <li>é€‰æ‹© "ä»¥æµ‹è¯•æ¨¡å¼å¯åŠ¨"</li>
      <li>ç‚¹å‡» "å¯ç”¨"</li>
      <li><button class="btn btn-small" onclick="location.reload()" style="margin-top:10px">ğŸ”„ åˆ·æ–°é¡µé¢</button></li>
    </ol>
  </div>
  
  <!-- ç”¨æˆ·ä¿¡æ¯ -->
  <div class="user-bar">
    <div class="user-info">
      <div class="user-avatar">ğŸ‘¤</div>
      <div class="user-name">æˆ‘æ˜¯ <span id="displayName">æˆ‘</span></div>
    </div>
    <div class="user-actions">
      <button class="btn-icon" id="renameLink">âœï¸ æ”¹å</button>
      <button class="btn-icon" id="joinBtn">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
    </div>
  </div>
  
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="statTotal">Â¥0</div>
      <div class="stat-label">æ€»å­˜æ¬¾</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statCount">0</div>
      <div class="stat-label">æˆ‘çš„è®¡åˆ’</div>
    </div>
  </div>
  
  <!-- æ–°å»ºè®¡åˆ’ -->
  <div class="glass-card">
    <div class="card-header">
      <div class="card-title">
        <div class="card-title-icon">ğŸ¯</div>
        æ–°å»ºå­˜é’±è®¡åˆ’
      </div>
    </div>
    <form id="createForm">
      <div class="form-group">
        <label class="form-label">è®¡åˆ’åç§°</label>
        <input type="text" class="form-input" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°æ–°è½¦ã€æ—…è¡ŒåŸºé‡‘ã€è´­æˆ¿é¦–ä»˜" required>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
        <div class="form-group">
          <label class="form-label">ç›®æ ‡é‡‘é¢ (Â¥)</label>
          <input type="number" class="form-input" id="gTarget" placeholder="100000" min="1" required>
        </div>
        <div class="form-group">
          <label class="form-label">è®¡åˆ’æ—¶é•¿ï¼ˆæœˆï¼‰</label>
          <input type="number" class="form-input" id="gMonths" placeholder="24" min="1" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">è®¡åˆ’ç±»å‹</label>
        <select class="form-select" id="gType">
          <option value="private">ğŸ”’ ç§äººè®¡åˆ’ - ä»…è‡ªå·±å¯è§</option>
          <option value="family">ğŸ‘¨â€ğŸ‘©â€
ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’ - å¤šäººå…±äº«ï¼Œå®æ—¶åŒæ­¥</option>
        </select>
      </div>
      <button type="submit" class="btn">âœ¨ åˆ›å»ºè®¡åˆ’</button>
    </form>
  </div>
  
  <!-- è®¡åˆ’åˆ—è¡¨ -->
  <div class="glass-card">
    <div class="tabs">
      <button class="tab active" data-tab="all">ğŸ“‹ å…¨éƒ¨</button>
      <button class="tab" data-tab="private">ğŸ”’ ç§äºº</button>
      <button class="tab" data-tab="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­</button>
    </div>
    <div id="goalsList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-text">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>
      </div>
    </div>
  </div>
  
  <!-- æœ€è¿‘è®°å½• -->
  <div class="glass-card">
    <div class="card-header">
      <div class="card-title">
        <div class="card-title-icon">ğŸ“</div>
        æœ€è¿‘å­˜å…¥è®°å½•
      </div>
    </div>
    <div id="recordsList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ’°</div>
        <div class="empty-state-text">è¿˜æ²¡æœ‰è®°å½•</div>
      </div>
    </div>
  </div>
</div>

<!-- å­˜å…¥æ¨¡æ€æ¡† -->
<div class="modal" id="depositModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ğŸ’° å­˜å…¥é‡‘é¢</div>
      <button class="modal-close" data-close="depositModal">&times;</button>
    </div>
    <div class="modal-body">
      <form id="depositForm">
        <input type="hidden" id="dGoalId">
        <div class="form-group">
          <label class="form-label">è®¡åˆ’åç§°</label>
          <input type="text" class="form-input" id="dGoalName" readonly style="background:#f5f5f5">
        </div>
        <div class="form-group">
          <label class="form-label">å­˜å…¥é‡‘é¢ (Â¥)</label>
          <input type="number" class="form-input" id="dAmount" placeholder="5000" min="1" required>
        </div>
        <div class="form-group">
          <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" class="form-input" id="dNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆå·¥èµ„ç»“ä½™">
        </div>
        <button type="submit" class="btn btn-gold" style="width:100%">ğŸ’¾ ç¡®è®¤å­˜å…¥</button>
      </form>
    </div>
  </div>
</div>

<!-- é‚€è¯·æ¨¡æ€æ¡† -->
<div class="modal" id="inviteModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ğŸ”— é‚€è¯·å®¶äºº</div>
      <button class="modal-close" data-close="inviteModal">&times;</button>
    </div>
    <div class="modal-body">
      <p style="color:#666;margin-bottom:15px">å¤åˆ¶åˆ†äº«ç ç»™å®¶äººï¼Œä»–ä»¬åŠ å…¥åæ•°æ®ä¼šå®æ—¶åŒæ­¥ï¼š</p>
      <div class="share-box" id="inviteCode"></div>
      <button class="btn" id="copyInviteBtn" style="width:100%">ğŸ“‹ å¤åˆ¶åˆ†äº«ç </button>
      <div style="margin-top:20px;padding:15px;background:#e3f2fd;border-radius:12px;font-size:0.9rem;color:#555">
        <strong>ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š</strong><br>
        1. å®¶äººç‚¹å‡»"åŠ å…¥å®¶åº­è®¡åˆ’"<br>
        2. ç²˜è´´æ­¤åˆ†äº«ç <br>
        3. æˆåŠŸåŠ å…¥åæ•°æ®å®æ—¶åŒæ­¥
      </div>
    </div>
  </div>
</div>

<!-- åŠ å…¥å®¶åº­è®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal" id="joinModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</div>
      <button class="modal-close" data-close="joinModal">&times;</button>
    </div>
    <div class="modal-body">
      <p style="color:#666;margin-bottom:15px">ç²˜è´´å®¶äººç»™ä½ çš„åˆ†äº«ç å³å¯åŠ å…¥ï¼š</p>
      <form id="joinForm">
        <div class="form-group">
          <label class="form-label">åˆ†äº«ç </label>
          <textarea class="form-input" id="joinCode" rows="4" placeholder="è¯·ç²˜è´´åˆ†äº«ç ..." required></textarea>
        </div>
        <button type="submit" class="btn" style="width:100%">ğŸš€ ç«‹å³åŠ å…¥å¹¶åŒæ­¥</button>
      </form>
    </div>
  </div>
</div>

<!-- æ”¹åæ¨¡æ€æ¡† -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">âœï¸ è®¾ç½®æ˜¾ç¤ºåç§°</div>
      <button class="modal-close" data-close="userModal">&times;</button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">ä½ çš„åå­—ï¼ˆä¼šæ˜¾ç¤ºåœ¨å­˜å…¥è®°å½•ä¸­ï¼‰</label>
          <input type="text" class="form-input" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸ã€å¦ˆå¦ˆã€å°æ˜" required>
        </div>
        <button type="submit" class="btn" style="width:100%">ğŸ’¾ ä¿å­˜</button>
      </form>
    </div>
  </div>
</div>

<!-- Toast æç¤º -->
<div class="toast" id="toast"></div>

<!-- ç‰ˆæœ¬æ ‡ç­¾ -->
<div class="version-tag">v11.0 ç¾å­¦ç‰ˆ</div>

<script>
// ==================== Firebase é…ç½® ====================
const firebaseConfig = {
  apiKey: "AIzaSyDZtyTKPzqzCmgCaPlCF9UoeLCOGs3okO4",
  authDomain: "savingmoney-6d898.firebaseapp.com",
  databaseURL: "https://savingmoney-6d898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "savingmoney-6d898",
  storageBucket: "savingmoney-6d898.firebasestorage.app",
  messagingSenderId: "364582624609",
  appId: "1:364582624609:web:f6077a7012b59f44fe7920",
  measurementId: "G-C891XVRC4N"
};

let db = null;
// syncListeners already defined above
let isOnline = false;

// åˆå§‹åŒ– Firebase
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
} catch(e) {
  console.log("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", e.message);
}

const STORAGE_KEY = "savings_v11_data";
const USER_KEY = "savings_v11_user";
let currentTab = "all";
let currentUser = "æˆ‘";

// æ›´æ–°çŠ¶æ€
function updateStatus(status, message) {
  const bar = document.getElementById("statusBar");
  const text = document.getElementById("statusText");
  bar.className = "status-bar " + status;
  text.innerHTML = message;
}

// æ£€æŸ¥ Firebase è¿æ¥
if (db) {
  db.ref(".info/connected").on("value", (snap) => {
    isOnline = snap.val() === true;
    if (isOnline) {
      updateStatus("online", "ğŸŸ¢ å·²è¿æ¥åˆ° SavingMoney äº‘ç«¯ï¼Œæ•°æ®å®æ—¶åŒæ­¥ä¸­");
      document.getElementById("setupGuide").style.display = "none";
      const data = loadLocalData();
      data.goals.filter(g => g.type === "family").forEach(g => startSync(g.id));
    } else {
      updateStatus("offline", "ğŸ”´ ç¦»çº¿æ¨¡å¼ - æ•°æ®ä¿å­˜åœ¨æœ¬åœ°");
    }
  }, (err) => {
    console.log("è¿æ¥é”™è¯¯:", err);
    updateStatus("config", "âš ï¸ éœ€è¦å¯ç”¨ Realtime Database");
    document.getElementById("setupGuide").style.display = "block";
  });
}

// Toast æç¤º
function showToast(message, duration = 3000) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, duration);
}

// èƒŒæ™¯ç²’å­æ•ˆæœ
function createParticles() {
  const container = document.getElementById("bgParticles");
  for (let i = 0; i < 20; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.style.left = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 20 + "s";
    particle.style.animationDuration = (15 + Math.random() * 10) + "s";
    container.appendChild(particle);
  }
}

// ==================== æ•°æ®ç®¡ç† ====================
function getUser() { return localStorage.getItem(USER_KEY) || "æˆ‘"; }
function setUser(name) { currentUser = name || "æˆ‘"; localStorage.setItem(USER_KEY, currentUser); }

function loadLocalData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : { goals: [], records: [] };
  } catch(e) { return { goals: [], records: [] }; }
}

function saveLocalData(data) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch(e) {
    showToast("ä¿å­˜å¤±è´¥ï¼š" + e.message);
    return false;
  }
}

function uploadToCloud(goalId) {
  if (!db || !isOnline) return Promise.resolve();
  const data = loadLocalData();
  const goal = data.goals.find(g => g.id === goalId);
  const records = data.records.filter(r => r.goalId === goalId);
  if (!goal) return Promise.resolve();
  return db.ref("plans/" + goalId).set({
    goal: goal,
    records: records,
    lastUpdate: Date.now()
  }).then(() => console.log("â˜ï¸ å·²ä¸Šä¼ :", goalId))
  .catch(err => console.log("âŒ ä¸Šä¼ å¤±è´¥:", err.message));
}

// syncListeners already defined above
function startSync(goalId) {
  if (!db || syncListeners[goalId]) return;
  console.log("ğŸ”„ å¼€å§‹åŒæ­¥:", goalId);
  const ref = db.ref("plans/" + goalId);
  syncListeners[goalId] = ref.on("value", (snapshot) => {
    const cloudData = snapshot.val();
    if (!cloudData) return;
    const localData = loadLocalData();
    const goalIndex = localData.goals.findIndex(g => g.id === goalId);
    if (goalIndex >= 0) {
      localData.goals[goalIndex] = cloudData.goal;
      if (cloudData.records) {
        cloudData.records.forEach(cloudRec => {
          if (!localData.records.find(r => r.id === cloudRec.id)) localData.records.push(cloudRec);
        });
      }
      saveLocalData(localData);
      render();
    }
  });
}

function stopSync(goalId) {
  if (syncListeners[goalId] && db) {
    db.ref("plans/" + goalId).off("value", syncListeners[goalId]);
    delete syncListeners[goalId];
  }
}

// ==================== å·¥å…·å‡½æ•° ====================
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 6); }
function fmtMoney(n) { return "Â¥" + parseFloat(n).toLocaleString("zh-CN", { maximumFractionDigits: 0 }); }
function getSaved(goalId, records) { return records.filter(r => r.goalId === goalId).reduce((s, r) => s + r.amount, 0); }
function canView(goal, user) {
  if (goal.type === "private") return goal.owner === user;
  if (goal.owner === user) return true;
  if (goal.members && goal.members.includes(user)) return true;
  return false;
}
function isOwner(goal) { return goal.owner === currentUser; }
function canDeposit(goal) { if (goal.type === "private") return goal.owner === currentUser; return canView(goal, currentUser); }
function canInvite(goal) { return goal.type === "family" && isOwner(goal); }
function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
function encodeShareCode(obj) { return btoa(encodeURIComponent(JSON.stringify(obj))); }
function decodeShareCode(code) { return JSON.parse(decodeURIComponent(atob(code))); }

// ==================== æ¸²æŸ“ ====================
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(t => {
    t.classList.toggle("active", t.dataset.tab === tab);
  });
  render();
}

function render() {
  const data = loadLocalData();
  currentUser = getUser();
  document.getElementById("displayName").textContent = currentUser;
  
  const myGoals = data.goals.filter(g => canView(g, currentUser));
  const total = myGoals.reduce((s, g) => s + getSaved(g.id, data.records), 0);
  document.getElementById("statTotal").textContent = fmtMoney(total);
  document.getElementById("statCount").textContent = myGoals.length;
  
  let visible = myGoals;
  if (currentTab === "private") visible = myGoals.filter(g => g.type === "private");
  if (currentTab === "family") visible = myGoals.filter(g => g.type === "family");
  
  const list = document.getElementById("goalsList");
  if (visible.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>';
  } else {
    list.innerHTML = visible.map(g => {
      const saved = getSaved(g.id, data.records);
      const pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
      const isDone = saved >= g.target;
      const isFamily = g.type === "family";
      const isSyncing = !!syncListeners[g.id];
      
      let members = [];
      if (isFamily) {
        members = [g.owner || "æˆ‘"];
        if (g.members) g.members.forEach(m => { if (m !== g.owner) members.push(m); });
      }
      
      let html = '<div class="goal-card ' + (isFamily ? 'family' : 'private') + '">';
      html += '<div class="goal-header">';
      html += '<div class="goal-title">' + escapeHtml(g.name) + '</div>';
      html += '<div class="goal-badges">';
      html += '<span class="badge ' + (isFamily ? 'badge-family' : 'badge-private') + '">';
      html += isFamily ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­' : 'ğŸ”’ ç§äºº';
      html += '</span>';
      if (isFamily && isSyncing) html += '<span class="badge badge-sync">ğŸ”„ åŒæ­¥ä¸­</span>';
      html += '</div></div>';
      
      if (isFamily && members.length > 0) {
        html += '<div class="members">';
        members.forEach(m => {
          const isMe = m === currentUser;
          const isOwn = m === g.owner;
          html += '<div class="member-avatar ' + (isMe ? 'me' : '') + ' ' + (isOwn ? 'owner' : '') + '">';
          html += '<span>' + (isMe ? 'ğŸ‘¤' : 'ğŸ‘¥') + '</span>';
          html += '<span>' + (isMe ? 'æˆ‘' : escapeHtml(m)) + '</span>';
          if (isOwn) html += '<span>ğŸ‘‘</span>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      html += '<div class="progress-section">';
      html += '<div class="progress-info"><span>è¿›åº¦ ' + pct + '%</span><span>' + (isDone ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­') + '</span></div>';
      html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
      html += '</div>';
      
      html += '<div class="goal-stats">';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(g.target) + '</div><div class="stat-item-label">ç›®æ ‡</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(saved) + '</div><div class="stat-item-label">å·²å­˜</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(Math.max(0, g.target - saved)) + '</div><div class="stat-item-label">å‰©ä½™</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(parseFloat(g.monthly)) + '</div><div class="stat-item-label">æ¯æœˆ</div></div>';
      html += '</div>';
      
      html += '<div class="goal-actions">';
      if (canDeposit(g)) {
        html += '<button type="button" class="btn btn-gold btn-small btn-deposit" data-id="' + g.id + '" data-name="' + escapeHtml(g.name) + '">ğŸ’° å­˜å…¥</button>';
      }
      if (canInvite(g)) {
        html += '<button type="button" class="btn btn-outline btn-small btn-invite" data-id="' + g.id + '">ğŸ”— é‚€è¯·</button>';
      }
      if (isOwner(g)) {
        html += '<button type="button" class="btn btn-danger btn-small btn-delete" data-id="' + g.id + '">ğŸ—‘ï¸ åˆ é™¤</button>';
      }
      html += '</div></div>';
      
      return html;
    }).join('');
  }
  
  const vids = myGoals.map(g => g.id);
  const recs = data.records.filter(r => vids.includes(r.goalId)).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
  const rlist = document.getElementById("recordsList");
  if (recs.length === 0) {
    rlist.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’°</div><div class="empty-state-text">è¿˜æ²¡æœ‰è®°å½•</div></div>';
  } else {
    rlist.innerHTML = recs.map(r => {
      const goal = data.goals.find(g => g.id === r.goalId);
      return '<div class="record-item"><div class="record-icon">ğŸ’µ</div><div class="record-content"><div class="record-amount">+' + fmtMoney(r.amount) + '</div><div class="record-meta">' + (goal ? escapeHtml(goal.name) : '') + ' Â· ' + (r.who || 'æˆ‘') + (r.note ? ' Â· ' + escapeHtml(r.note) : '') + '</div></div><div class="record-date">' + r.date.slice(0, 10) + '</div></div>';
    }).join('');
  }
}

function showModal(id) { document.getElementById(id).classList.add("active"); }
function closeModal(id) { document.getElementById(id).classList.remove("active"); }

// ==================== äº‹ä»¶ç»‘å®š ====================
document.addEventListener("DOMContentLoaded", () => {
  createParticles();
  currentUser = getUser();
  
  // Tabåˆ‡æ¢
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => switchTab(tab.dataset.tab));
  });
  
  // åˆ›å»ºè®¡åˆ’
  document.getElementById("createForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("gName").value.trim();
    const target = parseFloat(document.getElementById("gTarget").value);
    const months = parseInt(document.getElementById("gMonths").value);
    const type = document.getElementById("gType").value;
    
    if (!name || !target || !months) {
      showToast("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
      return;
    }
    
    const data = loadLocalData();
    const g = {
      id: genId(),
      name: name,
      target: target,
      months: months,
      monthly: (target / months).toFixed(2),
      type: type,
      owner: currentUser,
      members: [],
      createdAt: new Date().toISOString()
    };
    
    data.goals.push(g);
    if (!saveLocalData(data)) return;
    
    if (type === "family" && isOnline) {
      await uploadToCloud(g.id);
      startSync(g.id);
    }
    
    e.target.reset();
    render();
    showToast(type === "family" ? "âœ… å®¶åº­è®¡åˆ’åˆ›å»ºæˆåŠŸï¼ç‚¹å‡»é‚€è¯·æŒ‰é’®åˆ†äº«" : "âœ… ç§äººè®¡åˆ’åˆ›å»ºæˆåŠŸï¼");
  });
  
  // å­˜å…¥
  document.getElementById("depositForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const gid = document.getElementById("dGoalId").value;
    const amount = parseFloat(document.getElementById("dAmount").value);
    const note = document.getElementById("dNote").value;
    
    if (!amount || amount <= 0) {
      showToast("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
      return;
    }
    
    const data = loadLocalData();
    const goal = data.goals.find(g => g.id === gid);
    
    data.records.push({
      id: genId(),
      goalId: gid,
      amount: amount,
      note: note,
      who: currentUser,
      date: new Date().toISOString()
    });
    
    saveLocalData(data);
    
    if (goal && goal.type === "family" && isOnline) {
      await uploadToCloud(gid);
    }
    
    closeModal("depositModal");
    e.target.reset();
    render();
    showToast(goal && goal.type === "family" ? "âœ… å­˜å…¥æˆåŠŸï¼å·²åŒæ­¥åˆ°äº‘ç«¯" : "âœ… å­˜å…¥æˆåŠŸï¼");
  });
  
  // åŠ å…¥å®¶åº­è®¡åˆ’
  document.getElementById("joinForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const code = document.getElementById("joinCode").value.trim();
      if (!code) { showToast("è¯·è¾“å…¥åˆ†äº«ç "); return; }
      
      const share = decodeShareCode(code);
      if (share.type !== "savings_v4") throw new Error("æ— æ•ˆçš„åˆ†äº«ç æ ¼å¼");
      
      const data = loadLocalData();
      if (data.goals.find(g => g.id === share.planId)) {
        showToast("âš ï¸ ä½ å·²ç»åœ¨è¿™ä¸ªå®¶åº­è®¡åˆ’ä¸­äº†ï¼");
        return;
      }
      
      data.goals.push({
        id: share.planId,
        name: share.name,
        target: share.target,
        months: share.months,
        monthly: share.monthly,
        type: "family",
        owner: share.owner,
        members: [currentUser],
        joinedAt: new Date().toISOString()
      });
      
      saveLocalData(data);
      
      if (isOnline) {
        await uploadToCloud(share.planId);
        startSync(share.planId);
      }
      
      closeModal("joinModal");
      e.target.reset();
      render();
      showToast("âœ… æˆåŠŸåŠ å…¥å®¶åº­è®¡åˆ’ï¼");
    } catch(err) {
      showToast("âŒ åŠ å…¥å¤±è´¥ï¼š" + err.message);
    }
  });
  
  // æ”¹å
  document.getElementById("userForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const name = document.getElementById("userNameInput").value.trim();
    setUser(name || "æˆ‘");
    closeModal("userModal");
    render();
    showToast("âœ… åç§°å·²æ›´æ–°ä¸ºï¼š" + (name || "æˆ‘"));
  });
  
  // å¤åˆ¶é‚€è¯·ç 
  document.getElementById("copyInviteBtn").addEventListener("click", () => {
    const code = document.getElementById("inviteCode").textContent;
    if (!code) { showToast("æ²¡æœ‰é‚€è¯·ç å¯å¤åˆ¶"); return; }
    navigator.clipboard.writeText(code).then(() => {
      showToast("âœ… é‚€è¯·ç å·²å¤åˆ¶ï¼è¯·å‘ç»™å®¶äºº");
    }).catch(() => {
      showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
    });
  });
  
  // è®¡åˆ’å¡ç‰‡æŒ‰é’®
  document.getElementById("goalsList").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const gid = btn.dataset.id;
    if (!gid) return;
    
    if (btn.classList.contains("btn-deposit")) {
      document.getElementById("dGoalId").value = gid;
      document.getElementById("dGoalName").value = btn.dataset.name;
      showModal("depositModal");
    } else if (btn.classList.contains("btn-invite")) {
      const data = loadLocalData();
      const goal = data.goals.find(g => g.id === gid);
      if (!goal) { showToast("æ‰¾ä¸åˆ°è¯¥è®¡åˆ’"); return; }
      
      const share = {
        type: "savings_v4",
        version: 4,
        planId: goal.id,
        name: goal.name,
        target: goal.target,
        months: goal.months,
        monthly: goal.monthly,
        owner: goal.owner
      };
      
      try {
        const code = encodeShareCode(share);
        document.getElementById("inviteCode").textContent = code;
        showModal("inviteModal");
      } catch (err) {
        showToast("ç”Ÿæˆé‚€è¯·ç å¤±è´¥ï¼š" + err.message);
      }
    } else if (btn.classList.contains("btn-delete")) {
      if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’ï¼Ÿ")) return;
      const d = loadLocalData();
      d.goals = d.goals.filter(g => g.id !== gid);
      d.records = d.records.filter(r => r.goalId !== gid);
      saveLocalData(d);
      stopSync(gid);
      render();
      showToast("âœ… è®¡åˆ’å·²åˆ é™¤");
    }
  });
  
  // å…¶ä»–æŒ‰é’®
  document.getElementById("renameLink").addEventListener("click", () => {
    document.getElementById("userNameInput").value = currentUser;
    showModal("userModal");
  });
  
  document.getElementById("joinBtn").addEventListener("click", () => {
    showModal("joinModal");
  });
  
  // å…³é—­å¼¹çª—
  document.querySelectorAll("[data-close]").forEach(btn => {
    btn.addEventListener("click", () => closeModal(btn.dataset.close));
  });
  
  document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal(modal.id);
    });
  });
  
  render();
});

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      console.log('SW registered: ', registration.scope);
    }).catch(function(err) {
      console.log('SW registration failed: ', err);
    });
  });
}
</script>
</body>
</html>
