<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’µ å­˜é’±å°å·¥å…· - åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #85bb65 100%);
            min-height: 100vh;
            padding: 15px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 10px; }
        .sync-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            text-align: center;
            color: white;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .sync-status.offline { background: rgba(255,100,100,0.3); }
        .sync-status.online { background: rgba(100,255,100,0.3); }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
            animation: blink 1.5s infinite;
        }
        .sync-status.online .sync-dot {
            background: #44ff44;
            animation: none;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .user-bar {
            background: rgba(255,255,255,0.15);
            padding: 12px 15px;
            border-radius: 25px;
            text-align: center;
            color: white;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .user-bar a { color: #ffd700; text-decoration: underline; cursor: pointer; }
        .btn-join {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.4);
            animation: pulse 2s infinite;
        }
        .btn-sync {
            background: linear-gradient(135deg, #2196F3, #03A9F4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
        }
        .btn-sync:hover { transform: translateY(-2px); }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .section h2 { margin-bottom: 15px; color: #333; font-size: 1.1rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.8rem; opacity: 0.9; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; color: #555; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        input:focus, select:focus { outline: none; border-color: #1b5e20; }
        .btn {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-block;
        }
        .btn-gold {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #1b5e20;
            font-weight: bold;
        }
        .btn-small { padding: 8px 15px; font-size: 0.85rem; }
        .btn-outline { background: white; border: 2px solid #1b5e20; color: #1b5e20; }
        .btn-danger { background: #f56565; }
        .goal-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .goal-card.shared { border-color: #ffd700; background: linear-gradient(135deg, #fffde7, #fff); }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .goal-name { font-weight: bold; font-size: 1.1rem; }
        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .badge-private { background: #e3f2fd; color: #1976d2; }
        .badge-shared { background: #ffd700; color: #1b5e20; font-weight: bold; }
        .members { display: flex; gap: 5px; margin: 8px 0; flex-wrap: wrap; }
        .member-tag {
            background: #f0f0f0;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        .member-tag.me { background: #1b5e20; color: white; }
        .progress-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1b5e20, #4caf50, #ffd700);
            border-radius: 10px;
            transition: width 0.3s;
        }
        .goal-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
        }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: #999; }
        .share-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
            margin: 10px 0;
        }
        .empty { text-align: center; padding: 30px; color: #999; }
        .room-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        .room-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
            font-family: monospace;
            letter-spacing: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
        
        <div class="sync-status offline" id="syncStatus">
            <span class="sync-dot"></span>
            <span id="syncText">æœªè¿æ¥ - ç‚¹å‡»"å¼€å¯åŒæ­¥"è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</span>
        </div>
        
        <div class="user-bar">
            <span>æˆ‘æ˜¯: <strong id="displayName">æˆ‘</strong></span>
            <a onclick="showUserModal()">æ”¹å</a>
            <button class="btn-join" onclick="showJoinModal()">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
            <button class="btn-sync" onclick="showSyncModal()">ğŸ”„ å¼€å¯åŒæ­¥</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">Â¥0</div>
                <div class="stat-label">æ€»å­˜æ¬¾</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCount">0</div>
                <div class="stat-label">è¿›è¡Œä¸­çš„è®¡åˆ’</div>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ¯ æ–°å»ºç›®æ ‡</h2>
            <form id="createForm">
                <div class="form-group">
                    <label>ç›®æ ‡åç§°</label>
                    <input type="text" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°è½¦" required>
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡é‡‘é¢ (Â¥)</label>
                    <input type="number" id="gTarget" placeholder="50000" min="1" required>
                </div>
                <div class="form-group">
                    <label>è®¡åˆ’æœˆæ•°</label>
                    <input type="number" id="gMonths" placeholder="12" min="1" required>
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="gType">
                        <option value="private">ğŸ”’ ç§äººè®¡åˆ’</option>
                        <option value="shared">ğŸ‘¥ å…±äº«è®¡åˆ’ï¼ˆå¯é‚€è¯·å®¶äººï¼‰</option>
                    </select>
                </div>
                <button type="submit" class="btn">åˆ›å»ºç›®æ ‡</button>
            </form>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ æˆ‘çš„è®¡åˆ’</h2>
            <div id="goalsList"><div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“ æœ€è¿‘å­˜å…¥</h2>
            <div id="recordsList"><div class="empty">è¿˜æ²¡æœ‰è®°å½•</div></div>
        </div>
    </div>
    
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <div class="modal-header"><h3>å­˜å…¥é‡‘é¢</h3><span class="close-btn" onclick="closeModal('depositModal')">&times;</span></div>
            <form id="depositForm">
                <input type="hidden" id="dGoalId">
                <div class="form-group"><label>ç›®æ ‡</label><input type="text" id="dGoalName" readonly style="background:#f5f5f5"></div>
                <div class="form-group"><label>é‡‘é¢ (Â¥)</label><input type="number" id="dAmount" placeholder="1000" min="1" required></div>
                <div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="dNote" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„"></div>
                <button type="submit" class="btn btn-gold">ç¡®è®¤å­˜å…¥</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ”— é‚€è¯·å®¶äºº</h3><span class="close-btn" onclick="closeModal('shareModal')">&times;</span></div>
            <p>å¤åˆ¶ä¸‹æ–¹åˆ†äº«ç ç»™å®¶äººï¼š</p>
            <div class="share-box" id="shareCode"></div>
            <button class="btn" onclick="copyCode()">ğŸ“‹ å¤åˆ¶</button>
        </div>
    </div>
    
    <div class="modal" id="joinModal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</h3><span class="close-btn" onclick="closeModal('joinModal')">&times;</span></div>
            <form id="joinForm">
                <div class="form-group"><label>ç²˜è´´åˆ†äº«ç </label><textarea id="jCode" rows="4" placeholder="è¯·ç²˜è´´å®¶äººç»™ä½ çš„åˆ†äº«ç ..." required></textarea></div>
                <button type="submit" class="btn btn-gold">åŠ å…¥è®¡åˆ’</button>
            </form>
        </div>
    </div>
    
    <div class="modal" id="syncModal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ”„ å¤šè®¾å¤‡åŒæ­¥</h3><span class="close-btn" onclick="closeModal('syncModal')">&times;</span></div>
            <div id="syncPanel">
                <p>åˆ›å»ºä¸€ä¸ªåŒæ­¥æˆ¿é—´ï¼Œå…¶ä»–è®¾å¤‡è¾“å…¥ç›¸åŒæˆ¿é—´å·å³å¯å®æ—¶åŒæ­¥æ•°æ®ã€‚</p>
                <form id="syncForm" style="margin-top:15px;">
                    <div class="form-group"><label>æˆ¿é—´å·ï¼ˆ4ä½æ•°å­—ï¼‰</label><input type="text" id="roomCode" placeholder="ä¾‹å¦‚ï¼š1234" maxlength="4" pattern="\\d{4}" required></div>
                    <button type="submit" class="btn btn-sync" style="width:100%;">ğŸš€ è¿›å…¥æˆ¿é—´å¹¶åŒæ­¥</button>
                </form>
            </div>
            <div id="syncConnected" style="display:none;">
                <div class="room-info"><div style="color:#666;margin-bottom:5px;">å½“å‰æˆ¿é—´</div><div class="room-code" id="displayRoomCode"></div></div>
                <p style="text-align:center;color:#4caf50;">âœ… å·²è¿æ¥ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥</p>
                <button class="btn btn-danger" onclick="disconnectSync()" style="width:100%;margin-top:15px;">æ–­å¼€è¿æ¥</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ‘¤ è®¾ç½®åå­—</h3><span class="close-btn" onclick="closeModal('userModal')">&times;</span></div>
            <form id="userForm">
                <div class="form-group"><label>ä½ çš„åå­—</label><input type="text" id="uName" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸" required></div>
                <button type="submit" class="btn">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-SavingsTracker2024",
            authDomain: "savings-tracker-sync.firebaseapp.com",
            databaseURL: "https://savings-tracker-sync-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "savings-tracker-sync",
            storageBucket: "savings-tracker-sync.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:demo"
        };
        
        let db = null, currentRoom = null, unsubscribe = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('Firebase OK');
        } catch(e) { console.log('Firebase Error:', e); }
        
        const STORAGE_KEY = 'savings_family_v2';
        const USER_KEY = 'savings_user';
        const ROOM_KEY = 'savings_room';
        
        function getUser() { return localStorage.getItem(USER_KEY) || 'æˆ‘'; }
        function setUser(name) { localStorage.setItem(USER_KEY, name); }
        function getRoom() { return localStorage.getItem(ROOM_KEY); }
        function setRoom(room) { room ? localStorage.setItem(ROOM_KEY, room) : localStorage.removeItem(ROOM_KEY); }
        
        function loadData() {
            const d = localStorage.getItem(STORAGE_KEY);
            return d ? JSON.parse(d) : { goals: [], records: [] };
        }
        function saveData(data) { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            if (currentRoom && db) {
                db.ref('rooms/' + currentRoom + '/data').set(data);
            }
        }
        function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
        function fmtMoney(n) { return 'Â¥' + parseFloat(n).toLocaleString('zh-CN',{maximumFractionDigits:0}); }
        function getSaved(goalId, records) {
            return records.filter(r => r.goalId === goalId).reduce((s,r) => s + r.amount, 0);
        }
        
        // åŒæ­¥åŠŸèƒ½
        function showSyncModal() {
            const room = getRoom();
            if (room && db) {
                document.getElementById('syncPanel').style.display = 'none';
                document.getElementById('syncConnected').style.display = 'block';
                document.getElementById('displayRoomCode').textContent = room;
            } else {
                document.getElementById('syncPanel').style.display = 'block';
                document.getElementById('syncConnected').style.display = 'none';
            }
            showModal('syncModal');
        }
        
        document.getElementById('syncForm').onsubmit = function(e) {
            e.preventDefault();
            const roomCode = document.getElementById('roomCode').value;
            if (!db) { alert('âŒ ç½‘ç»œé—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'); return; }
            connectToRoom(roomCode);
        };
        
        function connectToRoom(roomCode) {
            currentRoom = roomCode;
            setRoom(roomCode);
            const roomRef = db.ref('rooms/' + roomCode + '/data');
            
            roomRef.once('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (cloudData) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(cloudData));
                    render();
                } else {
                    roomRef.set(loadData());
                }
                startListening(roomCode);
                document.getElementById('syncPanel').style.display = 'none';
                document.getElementById('syncConnected').style.display = 'block';
                document.getElementById('displayRoomCode').textContent = roomCode;
                updateSyncStatus(true);
                alert('âœ… å·²è¿æ¥åˆ°æˆ¿é—´ ' + roomCode);
            });
        }
        
        function startListening(roomCode) {
            if (unsubscribe) unsubscribe();
            unsubscribe = db.ref('rooms/' + roomCode + '/data').on('value', (snapshot) => {
                const cloudData = snapshot.val();
                if (cloudData) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(cloudData));
                    render();
                }
            });
        }
        
        function disconnectSync() {
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            currentRoom = null; setRoom(null); updateSyncStatus(false); closeModal('syncModal');
            alert('å·²æ–­å¼€è¿æ¥');
        }
        
        function updateSyncStatus(online) {
            const el = document.getElementById('syncStatus');
            const txt = document.getElementById('syncText');
            if (online) {
                el.className = 'sync-status online';
                txt.textContent = 'å·²è¿æ¥åˆ°æˆ¿é—´ ' + getRoom() + ' - å®æ—¶åŒæ­¥ä¸­';
            } else {
                el.className = 'sync-status offline';
                txt.textContent = 'æœªè¿æ¥ - ç‚¹å‡»"å¼€å¯åŒæ­¥"è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥';
            }
        }
        
        window.onload = function() {
            const savedRoom = getRoom();
            if (savedRoom && db) {
                currentRoom = savedRoom;
                startListening(savedRoom);
                updateSyncStatus(true);
            }
            render();
        };
        
        // æ¸²æŸ“
        function canSee(goal, user) {
            if (goal.type !== 'shared') return true;
            if (goal.owner === user) return true;
            if (goal.members && goal.members.includes(user)) return true;
            return false;
        }
        function isOwner(goal) { return goal.owner === getUser() || !goal.owner; }
        
        function render() {
            const data = loadData(), user = getUser();
            document.getElementById('displayName').textContent = user;
            const visible = data.goals.filter(g => canSee(g, user));
            const total = visible.reduce((s,g) => s + getSaved(g.id, data.records), 0);
            document.getElementById('statTotal').textContent = fmtMoney(total);
            document.getElementById('statCount').textContent = visible.length;
            
            const list = document.getElementById('goalsList');
            if (visible.length === 0) {
                list.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
            } else {
                list.innerHTML = visible.map(g => {
                    const saved = getSaved(g.id, data.records);
                    const pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
                    const isDone = saved >= g.target;
                    const shared = g.type === 'shared';
                    const members = shared ? [g.owner || 'æˆ‘', ...(g.members || [])] : [];
                    return `<div class="goal-card ${shared ? 'shared' : ''}">
                        <div class="goal-header"><span class="goal-name">${g.name}</span><span class="badge ${shared ? 'badge-shared' : 'badge-private'}">${shared ? 'ğŸ‘¥ å…±äº«' : 'ğŸ”’ ç§äºº'}</span></div>
                        ${shared ? `<div class="members">${members.map(m => `<span class="member-tag ${m === user ? 'me' : ''}">${m === user ? 'æˆ‘' : m}</span>`).join('')}</div>` : ''}
                        <div class="goal-info"><div>ç›®æ ‡: ${fmtMoney(g.target)}</div><div>å·²å­˜: ${fmtMoney(saved)}</div><div>å‰©ä½™: ${fmtMoney(Math.max(0, g.target - saved))}</div><div>æ¯æœˆ: ${fmtMoney(g.monthly)}</div></div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                        <div style="text-align:center;font-size:0.9rem;color:#666;margin-bottom:10px;">${pct}% ${isDone ? 'âœ… å·²å®Œæˆ' : ''}</div>
                        <div class="actions">
                            <button class="btn btn-gold btn-small" onclick="openDeposit('${g.id}', '${g.name}')">å­˜å…¥</button>
                            ${shared && isOwner(g) ? `<button class="btn btn-outline btn-small" onclick="openShare('${g.id}')">é‚€è¯·</button>` : ''}
                            ${isOwner(g) ? `<button class="btn btn-danger btn-small" onclick="delGoal('${g.id}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
            
            const visibleIds = visible.map(g => g.id);
            const recs = data.records.filter(r => visibleIds.includes(r.goalId)).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            const rlist = document.getElementById('recordsList');
            if (recs.length === 0) {
                rlist.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®°å½•</div>';
            } else {
                rlist.innerHTML = recs.map(r => {
                    const g = data.goals.find(x => x.id === r.goalId);
                    return `<div style="padding:10px;border-bottom:1px solid #f0f0f0;"><div style="display:flex;justify-content:space-between;"><span><strong style="color:#1b5e20;">+${fmtMoney(r.amount)}</strong> ${g ? g.name : 'æœªçŸ¥'}</span><span style="color:#999;font-size:0.8rem;">${r.date.slice(0,10)}</span></div><div style="font-size:0.85rem;color:#666;">${r.who || 'æˆ‘'} ${r.note ? '- ' + r.note : ''}</div></div>`;
                }).join('');
            }
        }
        
        // äº‹ä»¶
        document.getElementById('createForm').onsubmit = function(e) {
            e.preventDefault();
            const data = loadData();
            data.goals.push({
                id: genId(),
                name: document.getElementById('gName').value,
                target: parseFloat(document.getElementById('gTarget').value),
                months: parseInt(document.getElementById('gMonths').value),
                monthly: (parseFloat(document.getElementById('gTarget').value) / parseInt(document.getElementById('gMonths').value)).toFixed(2),
                type: document.getElementById('gType').value,
                owner: getUser(), members: [], created: new Date().toISOString()
            });
            saveData(data); this.reset(); render();
        };
        
        function openDeposit(gid, gname) {
            document.getElementById('dGoalId').value = gid;
            document.getElementById('dGoalName').value = gname;
            showModal('depositModal');
        }
        
        document.getElementById('depositForm').onsubmit = function(e) {
            e.preventDefault();
            const data = loadData();
            data.records.push({
                id: genId(), goalId: document.getElementById('dGoalId').value,
                amount: parseFloat(document.getElementById('dAmount').value),
                note: document.getElementById('dNote').value,
                who: getUser(), date: new Date().toISOString()
            });
            saveData(data); closeModal('depositModal'); this.reset(); render();
        };
        
        let shareGid = '';
        function openShare(gid) {
            shareGid = gid;
            const data = loadData(), g = data.goals.find(x => x.id === gid);
            if (!g) return;
            try {
                const shareObj = {type: 'savings_share', version: 1, goalId: g.id, name: g.name, target: g.target, months: g.months, monthly: g.monthly, owner: g.owner, records: data.records.filter(r => r.goalId === gid)};
                document.getElementById('shareCode').textContent = btoa(encodeURIComponent(JSON.stringify(shareObj)));
                showModal('shareModal');
            } catch (err) { alert('ç”Ÿæˆå¤±è´¥ï¼š' + err.message); }
        }
        
        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('shareCode').textContent).then(() => alert('å·²å¤åˆ¶ï¼'));
        }
        
        document.getElementById('joinForm').onsubmit = function(e) {
            e.preventDefault();
            try {
                const code = document.getElementById('jCode').value.trim();
                const shareObj = JSON.parse(decodeURIComponent(atob(code)));
                if (shareObj.type !== 'savings_share') throw new Error('æ— æ•ˆåˆ†äº«ç ');
                
                const data = loadData(), user = getUser();
                const existing = data.goals.find(g => g.id === shareObj.goalId);
                
                if (existing) {
                    if (!existing.members) existing.members = [];
                    if (!existing.members.includes(user) && existing.owner !== user) {
                        existing.members.push(user); saveData(data); alert('âœ… æˆåŠŸåŠ å…¥ï¼');
                    } else alert('ä½ å·²ç»æ˜¯æˆå‘˜äº†');
                } else {
                    data.goals.push({id: shareObj.goalId, name: shareObj.name, target: shareObj.target, months: shareObj.months, monthly: shareObj.monthly, type: 'shared', owner: shareObj.owner, members: [user], created: new Date().toISOString()});
                    shareObj.records.forEach(r => { if (!data.records.find(x => x.id === r.id)) data.records.push(r); });
                    saveData(data); alert('âœ… æˆåŠŸåŠ å…¥å…±äº«è®¡åˆ’ï¼');
                }
                closeModal('joinModal'); this.reset(); render();
            } catch (err) { alert('âŒ ' + err.message); }
        };
        
        function delGoal(gid) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            const data = loadData();
            data.goals = data.goals.filter(g => g.id !== gid);
            data.records = data.records.filter(r => r.goalId !== gid);
            saveData(data); render();
        }
        
        document.getElementById('userForm').onsubmit = function(e) {
            e.preventDefault();
            setUser(document.getElementById('uName').value);
            closeModal('userModal'); render();
        };
        
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showJoinModal() { showModal('joinModal'); }
        function showUserModal() { document.getElementById('uName').value = getUser(); showModal('userModal'); }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) e.target.classList.remove('active');
        };
    </script>
</body>
</html>