<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’µ å­˜é’±å°å·¥å…· - v3.0</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#1b5e20 0%,#2e7d32 50%,#85bb65 100%);min-height:100vh;padding:15px}
.container{max-width:800px;margin:0 auto}
h1{color:white;text-align:center;margin-bottom:10px}
.sync-indicator{display:flex;justify-content:center;gap:15px;margin-bottom:15px;flex-wrap:wrap}
.sync-badge{background:rgba(255,255,255,0.2);padding:6px 15px;border-radius:20px;color:white;font-size:0.8rem;display:flex;align-items:center;gap:6px}
.sync-badge.active{background:rgba(76,175,80,0.4)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:#ff9800}
.sync-badge.active .sync-dot{background:#4caf50;animation:pulse-dot 1.5s infinite}
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(0.8)}}
.user-bar{background:rgba(255,255,255,0.15);padding:12px 15px;border-radius:25px;text-align:center;color:white;margin-bottom:15px;font-size:0.9rem;display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px}
.user-bar a{color:#ffd700;text-decoration:underline;cursor:pointer}
.btn-join{background:linear-gradient(135deg,#ff6b35,#f7931e);color:white;padding:8px 16px;border-radius:20px;font-weight:bold;font-size:0.9rem;border:none;cursor:pointer;box-shadow:0 4px 8px rgba(255,107,53,0.4);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.section{background:white;border-radius:12px;padding:20px;margin-bottom:15px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.section h2{margin-bottom:15px;color:#333;font-size:1.1rem}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
.stat-card{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:white;padding:15px;border-radius:10px;text-align:center}
.stat-value{font-size:1.5rem;font-weight:bold}
.stat-label{font-size:0.8rem;opacity:0.9}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:5px;color:#555;font-size:0.9rem}
input,select,textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem}
input:focus,select:focus{outline:none;border-color:#1b5e20}
.btn{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:white;border:none;padding:12px 20px;border-radius:8px;font-size:1rem;cursor:pointer;display:inline-block}
.btn-gold{background:linear-gradient(135deg,#ffd700,#ffb300);color:#1b5e20;font-weight:bold}
.btn-small{padding:8px 15px;font-size:0.85rem}
.btn-outline{background:white;border:2px solid #1b5e20;color:#1b5e20}
.btn-danger{background:#f56565}
.goal-card{border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:12px;transition:all 0.3s}
.goal-card.syncing{border-color:#4caf50;box-shadow:0 0 0 2px rgba(76,175,80,0.2)}
.goal-card.shared{border-color:#ffd700;background:linear-gradient(135deg,#fffde7,#fff)}
.goal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.goal-name{font-weight:bold;font-size:1.1rem}
.badge{padding:3px 10px;border-radius:12px;font-size:0.75rem}
.badge-private{background:#e3f2fd;color:#1976d2}
.badge-shared{background:#ffd700;color:#1b5e20;font-weight:bold}
.badge-syncing{background:#4caf50;color:white;animation:blink-badge 2s infinite}
@keyframes blink-badge{0%,100%{opacity:1}50%{opacity:0.7}}
.members{display:flex;gap:5px;margin:8px 0;flex-wrap:wrap}
.member-tag{background:#f0f0f0;padding:3px 10px;border-radius:15px;font-size:0.8rem}
.member-tag.me{background:#1b5e20;color:white}
.progress-bar{height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,#1b5e20,#4caf50,#ffd700);border-radius:10px;transition:width 0.3s}
.goal-info{display:grid;grid-template-columns:repeat(2,1fr);gap:5px;font-size:0.85rem;color:#666;margin-bottom:10px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:25px;border-radius:12px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.close-btn{font-size:1.5rem;cursor:pointer;color:#999}
.share-box{background:#f5f5f5;padding:15px;border-radius:8px;border:2px dashed #ccc;font-family:monospace;font-size:0.85rem;word-break:break-all;margin:10px 0}
.empty{text-align:center;padding:30px;color:#999}
.version-tag{position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.5);color:white;padding:4px 10px;border-radius:10px;font-size:0.75rem}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
<div class="sync-indicator" id="syncIndicator"></div>
<div class="user-bar">
<span>æˆ‘æ˜¯: <strong id="displayName">æˆ‘</strong></span>
<a onclick="showUserModal()">æ”¹å</a>
<button class="btn-join" onclick="showJoinModal()">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statTotal">Â¥0</div><div class="stat-label">æ€»å­˜æ¬¾</div></div>
<div class="stat-card"><div class="stat-value" id="statCount">0</div><div class="stat-label">è¿›è¡Œä¸­çš„è®¡åˆ’</div></div>
</div>
<div class="section">
<h2>ğŸ¯ æ–°å»ºç›®æ ‡</h2>
<form id="createForm">
<div class="form-group"><label>ç›®æ ‡åç§°</label><input type="text" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°è½¦" required></div>
<div class="form-group"><label>ç›®æ ‡é‡‘é¢ (Â¥)</label><input type="number" id="gTarget" placeholder="50000" min="1" required></div>
<div class="form-group"><label>è®¡åˆ’æœˆæ•°</label><input type="number" id="gMonths" placeholder="12" min="1" required></div>
<div class="form-group"><label>ç±»å‹</label><select id="gType"><option value="private">ğŸ”’ ç§äººè®¡åˆ’ï¼ˆä»…è‡ªå·±å¯è§ï¼‰</option><option value="shared">ğŸ‘¥ å…±äº«è®¡åˆ’ï¼ˆåŠ å…¥åè‡ªåŠ¨åŒæ­¥ï¼‰</option></select></div>
<button type="submit" class="btn">åˆ›å»ºç›®æ ‡</button>
</form>
</div>
<div class="section">
<h2>ğŸ“‹ æˆ‘çš„è®¡åˆ’</h2>
<div id="goalsList"><div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>
</div>
<div class="section">
<h2>ğŸ“ æœ€è¿‘å­˜å…¥</h2>
<div id="recordsList"><div class="empty">è¿˜æ²¡æœ‰è®°å½•</div></div>
</div>
</div>
<div class="version-tag">v3.0</div>

<div class="modal" id="depositModal">
<div class="modal-content">
<div class="modal-header"><h3>å­˜å…¥é‡‘é¢</h3><span class="close-btn" onclick="closeModal('depositModal')">&times;</span></div>
<form id="depositForm">
<input type="hidden" id="dGoalId">
<div class="form-group"><label>ç›®æ ‡</label><input type="text" id="dGoalName" readonly style="background:#f5f5f5"></div>
<div class="form-group"><label>é‡‘é¢ (Â¥)</label><input type="number" id="dAmount" placeholder="1000" min="1" required></div>
<div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="dNote" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„"></div>
<button type="submit" class="btn btn-gold">ç¡®è®¤å­˜å…¥</button>
</form>
</div>
</div>

<div class="modal" id="shareModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ”— é‚€è¯·å®¶äººåŠ å…¥</h3><span class="close-btn" onclick="closeModal('shareModal')">&times;</span></div>
<p>å®¶äººåŠ å…¥åå°†<strong>è‡ªåŠ¨åŒæ­¥</strong>æ­¤è®¡åˆ’çš„æ‰€æœ‰æ›´æ–°ï¼š</p>
<div class="share-box" id="shareCode"></div>
<button class="btn" onclick="copyCode()">ğŸ“‹ å¤åˆ¶åˆ†äº«ç </button>
<p style="margin-top:15px;font-size:0.85rem;color:#666;">ğŸ’¡ æç¤ºï¼šå®¶äººç‚¹å‡»"åŠ å…¥å®¶åº­è®¡åˆ’"ç²˜è´´æ­¤ç å³å¯è‡ªåŠ¨åŒæ­¥</p>
</div>
</div>

<div class="modal" id="joinModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</h3><span class="close-btn" onclick="closeModal('joinModal')">&times;</span></div>
<p style="margin-bottom:15px;color:#666;">åŠ å…¥åè¯¥è®¡åˆ’çš„æ›´æ–°ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä½ çš„è®¾å¤‡</p>
<form id="joinForm">
<div class="form-group"><label>ç²˜è´´åˆ†äº«ç </label><textarea id="jCode" rows="4" placeholder="è¯·ç²˜è´´å®¶äººç»™ä½ çš„åˆ†äº«ç ..." required></textarea></div>
<button type="submit" class="btn btn-gold">åŠ å…¥è®¡åˆ’å¹¶åŒæ­¥</button>
</form>
</div>
</div>

<div class="modal" id="userModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘¤ è®¾ç½®åå­—</h3><span class="close-btn" onclick="closeModal('userModal')">&times;</span></div>
<form id="userForm">
<div class="form-group"><label>ä½ çš„åå­—ï¼ˆä¼šæ˜¾ç¤ºåœ¨è®°å½•ä¸­ï¼‰</label><input type="text" id="uName" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸" required></div>
<button type="submit" class="btn">ä¿å­˜</button>
</form>
</div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyDemo-SavingsTracker2024",authDomain:"savings-tracker-sync.firebaseapp.com",databaseURL:"https://savings-tracker-sync-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"savings-tracker-sync",storageBucket:"savings-tracker-sync.appspot.com",messagingSenderId:"123456789",appId:"1:123456789:web:demo"};
let db=null,listeners={};
try{firebase.initializeApp(firebaseConfig);db=firebase.database();console.log('Firebase OK')}catch(e){console.log('Firebase Error:',e)}
const STORAGE_KEY='savings_v3_data',USER_KEY='savings_v3_user';
function getUser(){return localStorage.getItem(USER_KEY)||'æˆ‘'}
function setUser(name){localStorage.setItem(USER_KEY,name)}
function loadData(){const d=localStorage.getItem(STORAGE_KEY);return d?JSON.parse(d):{goals:[],records:[]}}
function saveData(data){localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function fmtMoney(n){return'Â¥'+parseFloat(n).toLocaleString('zh-CN',{maximumFractionDigits:0})}
function getSaved(goalId,records){return records.filter(r=>r.goalId===goalId).reduce((s,r)=>s+r.amount,0)}

function startGoalSync(goalId){if(!db||listeners[goalId])return;console.log('å¼€å§‹åŒæ­¥:',goalId);const goalRef=db.ref('shared_goals/'+goalId);listeners[goalId]=goalRef.on('value',(snapshot)=>{const cloudData=snapshot.val();if(!cloudData)return;const localData=loadData();const idx=localData.goals.findIndex(g=>g.id===goalId);if(idx>=0){localData.goals[idx]={...localData.goals[idx],...cloudData.goal};if(cloudData.records){cloudData.records.forEach(cr=>{if(!localData.records.find(r=>r.id===cr.id))localData.records.push(cr)})}saveData(localData);render();console.log('åŒæ­¥å®Œæˆ:',goalId)}});updateSyncIndicator()}
function stopGoalSync(goalId){if(listeners[goalId]){db.ref('shared_goals/'+goalId).off('value',listeners[goalId]);delete listeners[goalId];updateSyncIndicator()}}
function uploadGoalUpdate(goalId){if(!db)return;const data=loadData(),goal=data.goals.find(g=>g.id===goalId),recs=data.records.filter(r=>r.goalId===goalId);if(goal)db.ref('shared_goals/'+goalId).set({goal:goal,records:recs,lastUpdate:Date.now()})}
function updateSyncIndicator(){const c=document.getElementById('syncIndicator'),syncing=Object.keys(listeners);if(syncing.length===0){c.innerHTML='';return}c.innerHTML=syncing.map(gid=>{const data=loadData(),goal=data.goals.find(g=>g.id===gid);return'<div class="sync-badge active"><span class="sync-dot"></span><span>'+(goal?goal.name:'è®¡åˆ’')+' åŒæ­¥ä¸­</span></div>'}).join('')}
function checkAndStartSync(){const data=loadData();data.goals.filter(g=>g.type==='shared').forEach(g=>startGoalSync(g.id))}

function canSee(goal,user){if(goal.type!=='shared')return true;if(goal.owner===user)return true;if(goal.members&&goal.members.includes(user))return true;return false}
function isOwner(goal){return goal.owner===getUser()||!goal.owner}
function render(){const data=loadData(),user=getUser();document.getElementById('displayName').textContent=user;const visible=data.goals.filter(g=>canSee(g,user)),total=visible.reduce((s,g)=>s+getSaved(g.id,data.records),0);document.getElementById('statTotal').textContent=fmtMoney(total);document.getElementById('statCount').textContent=visible.length;const list=document.getElementById('goalsList');if(visible.length===0){list.innerHTML='<div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>'}else{list.innerHTML=visible.map(g=>{const saved=getSaved(g.id,data.records),pct=Math.min(100,(saved/g.target*100)).toFixed(1),isDone=saved>=g.target,shared=g.type==='shared',members=shared?[g.owner||'æˆ‘',...(g.members||[])]:[],isSyncing=!!listeners[g.id];return'<div class="goal-card '+(shared?'shared':'')+(isSyncing?' syncing':'')+'"><div class="goal-header"><span class="goal-name">'+g.name+'</span><div>'+(isSyncing?'<span class="badge badge-syncing">ğŸ”„ åŒæ­¥ä¸­</span> ':'')+'<span class="badge '+(shared?'badge-shared':'badge-private')+'">'+(shared?'ğŸ‘¥ å…±äº«':'ğŸ”’ ç§äºº')+'</span></div></div>'+(shared?'<div class="members">'+members.map(m=>'<span class="member-tag '+(m===user?'me':'')+'">'+(m===user?'æˆ‘':m)+'</span>').join('')+'</div>':'')+'<div class="goal-info"><div>ç›®æ ‡: '+fmtMoney(g.target)+'</div><div>å·²å­˜: '+fmtMoney(saved)+'</div><div>å‰©ä½™: '+fmtMoney(Math.max(0,g.target-saved))+'</div><div>æ¯æœˆ: '+fmtMoney(g.monthly)+'</div></div><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%"></div></div><div style="text-align:center;font-size:0.9rem;color:#666;margin-bottom:10px;">'+pct+'% '+(isDone?'âœ… å·²å®Œæˆ':'')+'</div><div class="actions"><button class="btn btn-gold btn-small" onclick="openDeposit(''+g.id+'',''+g.name+'')">å­˜å…¥</button>'+(shared&&isOwner(g)?'<button class="btn btn-outline btn-small" onclick="openShare(''+g.id+'')">é‚€è¯·</button>':'')+(isOwner(g)?'<button class="btn btn-danger btn-small" onclick="delGoal(''+g.id+'')">åˆ é™¤</button>':'')+'</div></div>'}).join('')}const vids=visible.map(g=>g.id),recs=data.records.filter(r=>vids.includes(r.goalId)).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10),rlist=document.getElementById('recordsList');if(recs.length===0){rlist.innerHTML='<div class="empty">è¿˜æ²¡æœ‰è®°å½•</div>'}else{rlist.innerHTML=recs.map(r=>{const g=data.goals.find(x=>x.id===r.goalId);return'<div style="padding:10px;border-bottom:1px solid #f0f0f0;"><div style="display:flex;justify-content:space-between;"><span><strong style="color:#1b5e20;">+'+fmtMoney(r.amount)+'</strong> '+(g?g.name:'æœªçŸ¥')+'</span><span style="color:#999;font-size:0.8rem;">'+r.date.slice(0,10)+'</span></div><div style="font-size:0.85rem;color:#666;">'+(r.who||'æˆ‘')+(r.note?' - '+r.note:'')+'</div></div>'}).join('')}}

document.getElementById('createForm').onsubmit=function(e){e.preventDefault();const data=loadData(),isShared=document.getElementById('gType').value==='shared',g={id:genId(),name:document.getElementById('gName').value,target:parseFloat(document.getElementById('gTarget').value),months:parseInt(document.getElementById('gMonths').value),monthly:(parseFloat(document.getElementById('gTarget').value)/parseInt(document.getElementById('gMonths').value)).toFixed(2),type:document.getElementById('gType').value,owner:getUser(),members:[],created:new Date().toISOString()};data.goals.push(g);saveData(data);if(isShared&&db){uploadGoalUpdate(g.id);startGoalSync(g.id)}this.reset();render()};
function openDeposit(gid,gname){document.getElementById('dGoalId').value=gid;document.getElementById('dGoalName').value=gname;showModal('depositModal')}
document.getElementById('depositForm').onsubmit=function(e){e.preventDefault();const gid=document.getElementById('dGoalId').value,data=loadData();data.records.push({id:genId(),goalId:gid,amount:parseFloat(document.getElementById('dAmount').value),note:document.getElementById('dNote').value,who:getUser(),date:new Date().toISOString()});saveData(data);const goal=data.goals.find(g=>g.id===gid);if(goal&&goal.type==='shared')uploadGoalUpdate(gid);closeModal('depositModal');this.reset();render()};
let shareGid='';function openShare(gid){shareGid=gid;const data=loadData(),g=data.goals.find(x=>x.id===gid);if(!g)return;try{const shareObj={type:'savings_join',version:3,goalId:g.id,name:g.name,target:g.target,months:g.months,monthly:g.monthly,owner:g.owner,records:data.records.filter(r=>r.goalId===gid)};document.getElementById('shareCode').textContent=btoa(encodeURIComponent(JSON.stringify(shareObj)));showModal('shareModal')}catch(err){alert('ç”Ÿæˆå¤±è´¥ï¼š'+err.message)}}
function copyCode(){navigator.clipboard.writeText(document.getElementById('shareCode').textContent).then(()=>alert('å·²å¤åˆ¶ï¼'))}
document.getElementById('joinForm').onsubmit=function(e){e.preventDefault();try{const code=document.getElementById('jCode').value.trim(),shareObj=JSON.parse(decodeURIComponent(atob(code)));if(shareObj.type!=='savings_join')throw new Error('æ— æ•ˆçš„åˆ†äº«ç ');const data=loadData(),user=getUser(),goalId=shareObj.goalId;let goal=data.goals.find(g=>g.id===goalId);if(goal){if(!goal.members)goal.members=[];if(!goal.members.includes(user)&&goal.owner!==user){goal.members.push(user);saveData(data)}}else{goal={id:goalId,name:shareObj.name,target:shareObj.target,months:shareObj.months,monthly:shareObj.monthly,type:'shared',owner:shareObj.owner,members:[user],created:new Date().toISOString()};data.goals.push(goal);shareObj.records.forEach(r=>{if(!data.records.find(x=>x.id===r.id))data.records.push(r)});saveData(data)}startGoalSync(goalId);closeModal('joinModal');this.reset();render();alert('âœ… æˆåŠŸåŠ å…¥ï¼è¯¥è®¡åˆ’å°†è‡ªåŠ¨åŒæ­¥ã€‚')}catch(err){alert('âŒ '+err.message)}};
function delGoal(gid){if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;stopGoalSync(gid);const data=loadData();data.goals=data.goals.filter(g=>g.id!==gid);data.records=data.records.filter(r=>r.goalId!==gid);saveData(data);render()}
document.getElementById('userForm').onsubmit=function(e){e.preventDefault();setUser(document.getElementById('uName').value);closeModal('userModal');render()}
function showModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function showJoinModal(){showModal('joinModal')}
function showUserModal(){document.getElementById('uName').value=getUser();showModal('userModal')}
window.onclick=function(e){if(e.target.classList.contains('modal'))e.target.classList.remove('active')}
window.onload=function(){checkAndStartSync();render()}
</script>
</body>
</html>