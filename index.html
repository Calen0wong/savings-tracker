<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’µ å­˜é’±å°å·¥å…· - v5.0 æœ€ç»ˆç‰ˆ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: linear-gradient(135deg, #1b5e20, #2e7d32, #85bb65);
  min-height: 100vh;
  padding: 15px;
}
.container { max-width: 800px; margin: 0 auto; }
h1 { color: white; text-align: center; margin-bottom: 10px; font-size: 1.8rem; }
.user-bar {
  background: rgba(255,255,255,0.15);
  padding: 12px;
  border-radius: 25px;
  text-align: center;
  color: white;
  margin-bottom: 15px;
  font-size: 0.9rem;
}
.user-bar a { color: #ffd700; cursor: pointer; text-decoration: underline; margin: 0 10px; }
.section {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.section h2 { margin-bottom: 15px; color: #333; font-size: 1.1rem; }
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
.stat-card {
  background: linear-gradient(135deg, #1b5e20, #2e7d32);
  color: white;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
}
.stat-value { font-size: 1.5rem; font-weight: bold; }
.form-group { margin-bottom: 12px; }
label { display: block; margin-bottom: 5px; color: #555; font-size: 0.9rem; }
input, select, textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
}
.btn {
  background: linear-gradient(135deg, #1b5e20, #2e7d32);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  display: inline-block;
}
.btn-gold { background: linear-gradient(135deg, #ffd700, #ffb300); color: #1b5e20; font-weight: bold; }
.btn-small { padding: 8px 15px; font-size: 0.85rem; }
.btn-outline { background: white; border: 2px solid #1b5e20; color: #1b5e20; }
.btn-danger { background: #f56565; }
.plan-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
.plan-tab { padding: 8px 16px; cursor: pointer; border-radius: 20px; background: #f5f5f5; color: #666; }
.plan-tab.active { background: #1b5e20; color: white; }
.goal-card { border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
.goal-card.private { border-left: 4px solid #2196F3; }
.goal-card.family { border-left: 4px solid #ff9800; background: #fffde7; }
.goal-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
.goal-name { font-weight: bold; font-size: 1.1rem; }
.badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; }
.badge-private { background: #e3f2fd; color: #1976d2; }
.badge-family { background: #ff9800; color: white; }
.members { display: flex; gap: 5px; margin: 10px 0; flex-wrap: wrap; }
.member-tag { background: #f5f5f5; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; }
.member-tag.me { background: #1b5e20; color: white; }
.progress-bar { height: 20px; background: #e8e8e8; border-radius: 10px; overflow: hidden; margin: 10px 0; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #1b5e20, #4caf50, #ffd700); border-radius: 10px; transition: width 0.5s; }
.goal-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; font-size: 0.8rem; color: #666; text-align: center; }
.actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.close-btn { font-size: 1.5rem; cursor: pointer; color: #999; }
.share-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px dashed #ccc; font-family: monospace; font-size: 0.8rem; word-break: break-all; margin: 10px 0; }
.empty { text-align: center; padding: 30px; color: #999; }
.version-tag { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.4); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
  <div class="user-bar">
    æˆ‘æ˜¯: <strong id="displayName">æˆ‘</strong>
    <a id="renameLink">æ”¹å</a>
    <button class="btn" id="joinBtn" style="margin-left: 10px;">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
  </div>
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-value" id="statTotal">Â¥0</div><div class="stat-label">æ€»å­˜æ¬¾</div></div>
    <div class="stat-card"><div class="stat-value" id="statCount">0</div><div class="stat-label">æˆ‘çš„è®¡åˆ’</div></div>
  </div>
  <div class="section">
    <h2>ğŸ¯ æ–°å»ºè®¡åˆ’</h2>
    <form id="createForm">
      <div class="form-group">
        <label>è®¡åˆ’åç§°</label>
        <input type="text" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°æ–°è½¦" required>
      </div>
      <div class="form-group">
        <label>ç›®æ ‡é‡‘é¢ (Â¥)</label>
        <input type="number" id="gTarget" placeholder="100000" min="1" required>
      </div>
      <div class="form-group">
        <label>è®¡åˆ’æ—¶é•¿ï¼ˆæœˆï¼‰</label>
        <input type="number" id="gMonths" placeholder="24" min="1" required>
      </div>
      <div class="form-group">
        <label>è®¡åˆ’ç±»å‹</label>
        <select id="gType">
          <option value="private">ğŸ”’ ç§äººè®¡åˆ’ - ä»…è‡ªå·±å¯è§</option>
          <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’ - é‚€è¯·æˆå‘˜å…±äº«</option>
        </select>
      </div>
      <button type="submit" class="btn">âœ¨ åˆ›å»ºè®¡åˆ’</button>
    </form>
  </div>
  <div class="section">
    <div class="plan-tabs">
      <div class="plan-tab active" data-tab="all">å…¨éƒ¨</div>
      <div class="plan-tab" data-tab="private">ğŸ”’ ç§äºº</div>
      <div class="plan-tab" data-tab="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­</div>
    </div>
    <h2 id="planTitle">ğŸ“‹ æˆ‘çš„è®¡åˆ’</h2>
    <div id="goalsList"><div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>
  </div>
  <div class="section">
    <h2>ğŸ“ æœ€è¿‘å­˜å…¥è®°å½•</h2>
    <div id="recordsList"><div class="empty">è¿˜æ²¡æœ‰è®°å½•</div></div>
  </div>
</div>
<div class="version-tag">v5.0 æœ€ç»ˆç‰ˆ</div>

<div class="modal" id="depositModal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ’° å­˜å…¥é‡‘é¢</h3><span class="close-btn" data-close="depositModal">&times;</span></div>
    <form id="depositForm">
      <input type="hidden" id="dGoalId">
      <div class="form-group"><label>è®¡åˆ’åç§°</label><input type="text" id="dGoalName" readonly style="background:#f5f5f5"></div>
      <div class="form-group"><label>å­˜å…¥é‡‘é¢ (Â¥)</label><input type="number" id="dAmount" placeholder="5000" min="1" required></div>
      <div class="form-group"><label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="dNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆå·¥èµ„"></div>
      <button type="submit" class="btn btn-gold" style="width:100%">ç¡®è®¤å­˜å…¥</button>
    </form>
  </div>
</div>

<div class="modal" id="inviteModal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ”— é‚€è¯·å®¶äºº</h3><span class="close-btn" data-close="inviteModal">&times;</span></div>
    <p style="color:#666;margin-bottom:10px">å¤åˆ¶åˆ†äº«ç ç»™å®¶äººï¼š</p>
    <div class="share-box" id="inviteCode"></div>
    <button class="btn" id="copyInviteBtn" style="width:100%">ğŸ“‹ å¤åˆ¶</button>
  </div>
</div>

<div class="modal" id="joinModal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</h3><span class="close-btn" data-close="joinModal">&times;</span></div>
    <p style="color:#666;margin-bottom:10px">åŠ å…¥åå³å¯ä¸å®¶äººå®æ—¶å…±äº«ï¼š</p>
    <form id="joinForm">
      <div class="form-group"><label>ç²˜è´´åˆ†äº«ç </label><textarea id="joinCode" rows="4" placeholder="è¯·ç²˜è´´åˆ†äº«ç ..." required></textarea></div>
      <button type="submit" class="btn" style="width:100%">ç«‹å³åŠ å…¥</button>
    </form>
  </div>
</div>

<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header"><h3>è®¾ç½®åç§°</h3><span class="close-btn" data-close="userModal">&times;</span></div>
    <form id="userForm">
      <div class="form-group"><label>ä½ çš„åå­—</label><input type="text" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸" required></div>
      <button type="submit" class="btn" style="width:100%">ä¿å­˜</button>
    </form>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const STORAGE_KEY = "savings_final_data";
const USER_KEY = "savings_final_user";
let currentTab = "all";
let currentInviteGoalId = null;

// ==================== å·¥å…·å‡½æ•° ====================
function getUser() {
  return localStorage.getItem(USER_KEY) || "æˆ‘";
}

function setUser(name) {
  localStorage.setItem(USER_KEY, name);
}

function loadData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : {goals: [], records: []};
  } catch(e) {
    return {goals: [], records: []};
  }
}

function saveData(data) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch(e) {
    alert("ä¿å­˜å¤±è´¥ï¼š" + e.message);
    return false;
  }
}

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

function fmtMoney(n) {
  return "Â¥" + parseFloat(n).toLocaleString("zh-CN", {maximumFractionDigits: 0});
}

function getSaved(goalId, records) {
  return records.filter(function(r) { return r.goalId === goalId; }).reduce(function(s, r) { return s + r.amount; }, 0);
}

// ==================== æƒé™æ£€æŸ¥ ====================
function canView(goal, user) {
  if (goal.type === "private") return goal.owner === user;
  if (goal.owner === user) return true;
  if (goal.members && goal.members.indexOf(user) >= 0) return true;
  return false;
}

function isOwner(goal) {
  return goal.owner === getUser();
}

function canDeposit(goal) {
  var user = getUser();
  if (goal.type === "private") return goal.owner === user;
  return canView(goal, user);
}

// ==================== æ¸²æŸ“ ====================
function switchTab(tab) {
  currentTab = tab;
  var tabs = document.querySelectorAll(".plan-tab");
  for (var i = 0; i < tabs.length; i++) {
    if (tabs[i].dataset.tab === tab) {
      tabs[i].classList.add("active");
    } else {
      tabs[i].classList.remove("active");
    }
  }
  var titles = {all: "ğŸ“‹ å…¨éƒ¨è®¡åˆ’", private: "ğŸ”’ ç§äººè®¡åˆ’", family: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’"};
  document.getElementById("planTitle").textContent = titles[tab];
  render();
}

function render() {
  var data = loadData();
  var user = getUser();
  
  document.getElementById("displayName").textContent = user;
  
  var myGoals = [];
  for (var i = 0; i < data.goals.length; i++) {
    if (canView(data.goals[i], user)) {
      myGoals.push(data.goals[i]);
    }
  }
  
  var total = 0;
  for (var j = 0; j < myGoals.length; j++) {
    total += getSaved(myGoals[j].id, data.records);
  }
  
  document.getElementById("statTotal").textContent = fmtMoney(total);
  document.getElementById("statCount").textContent = myGoals.length;
  
  var visible = myGoals;
  if (currentTab === "private") {
    visible = myGoals.filter(function(g) { return g.type === "private"; });
  }
  if (currentTab === "family") {
    visible = myGoals.filter(function(g) { return g.type === "family"; });
  }
  
  var list = document.getElementById("goalsList");
  if (visible.length === 0) {
    list.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
  } else {
    var html = '';
    for (var k = 0; k < visible.length; k++) {
      var g = visible[k];
      var saved = getSaved(g.id, data.records);
      var pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
      var isDone = saved >= g.target;
      var isFamily = g.type === "family";
      var members = isFamily ? [g.owner || "æˆ‘"].concat(g.members || []) : [];
      
      html += '<div class="goal-card ' + (isFamily ? 'family' : 'private') + '" data-goal-id="' + g.id + '">';
      html += '<div class="goal-header">';
      html += '<span class="goal-name">' + g.name + '</span>';
      html += '<span class="badge ' + (isFamily ? 'badge-family' : 'badge-private') + '">';
      html += isFamily ? 'å®¶åº­' : 'ç§äºº';
      html += '</span></div>';
      
      if (isFamily && members.length > 0) {
        html += '<div class="members">';
        for (var m = 0; m < members.length; m++) {
          var member = members[m];
          html += '<span class="member-tag ' + (member === user ? 'me' : '') + '">';
          html += (member === user ? 'æˆ‘' : member);
          if (member === g.owner) html += ' ğŸ‘‘';
          html += '</span>';
        }
        html += '</div>';
      }
      
      html += '<div class="goal-stats">';
      html += '<div><strong>' + fmtMoney(g.target) + '</strong><br>ç›®æ ‡</div>';
      html += '<div><strong>' + fmtMoney(saved) + '</strong><br>å·²å­˜</div>';
      html += '<div><strong>' + fmtMoney(Math.max(0, g.target - saved)) + '</strong><br>å‰©ä½™</div>';
      html += '<div><strong>' + fmtMoney(g.monthly) + '</strong><br>æ¯æœˆ</div>';
      html += '</div>';
      
      html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
      html += '<div style="text-align:center;font-size:0.9rem;color:#666;margin:5px 0">' + pct + '% ' + (isDone ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­') + '</div>';
      
      html += '<div class="actions">';
      if (canDeposit(g)) {
        html += '<button class="btn btn-gold btn-small action-deposit" data-goal-id="' + g.id + '" data-goal-name="' + g.name + '">å­˜å…¥</button>';
      }
      if (isFamily && isOwner(g)) {
        html += '<button class="btn btn-outline btn-small action-invite" data-goal-id="' + g.id + '">é‚€è¯·</button>';
      }
      if (isOwner(g)) {
        html += '<button class="btn btn-danger btn-small action-delete" data-goal-id="' + g.id + '">åˆ é™¤</button>';
      }
      html += '</div></div>';
    }
    list.innerHTML = html;
  }
  
  // æ¸²æŸ“è®°å½•
  var vids = [];
  for (var n = 0; n < myGoals.length; n++) {
    vids.push(myGoals[n].id);
  }
  
  var recs = [];
  for (var p = 0; p < data.records.length; p++) {
    if (vids.indexOf(data.records[p].goalId) >= 0) {
      recs.push(data.records[p]);
    }
  }
  
  recs.sort(function(a, b) {
    return new Date(b.date) - new Date(a.date);
  });
  recs = recs.slice(0, 15);
  
  var rlist = document.getElementById("recordsList");
  if (recs.length === 0) {
    rlist.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®°å½•</div>';
  } else {
    var rhtml = '';
    for (var q = 0; q < recs.length; q++) {
      var r = recs[q];
      var goal = null;
      for (var rIdx = 0; rIdx < data.goals.length; rIdx++) {
        if (data.goals[rIdx].id === r.goalId) {
          goal = data.goals[rIdx];
          break;
        }
      }
      rhtml += '<div style="padding:10px;border-bottom:1px solid #f0f0f0">';
      rhtml += '<div style="display:flex;justify-content:space-between">';
      rhtml += '<span><strong style="color:#1b5e20">+' + fmtMoney(r.amount) + '</strong> ' + (goal ? goal.name : '') + '</span>';
      rhtml += '<span style="color:#999;font-size:0.8rem">' + r.date.slice(0, 10) + '</span>';
      rhtml += '</div>';
      rhtml += '<div style="font-size:0.85rem;color:#666">' + (r.who || 'æˆ‘') + ' å­˜å…¥' + (r.note ? ' Â· ' + r.note : '') + '</div>';
      rhtml += '</div>';
    }
    rlist.innerHTML = rhtml;
  }
}

// ==================== å·¥å…·å‡½æ•° ====================
function showModal(id) {
  document.getElementById(id).classList.add("active");
}

function closeModal(id) {
  document.getElementById(id).classList.remove("active");
}

// ==================== åˆå§‹åŒ– ====================
document.addEventListener("DOMContentLoaded", function() {
  console.log("åˆå§‹åŒ–å¼€å§‹");
  
  // Tabåˆ‡æ¢
  var tabs = document.querySelectorAll(".plan-tab");
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].addEventListener("click", function() {
      switchTab(this.dataset.tab);
    });
  }
  
  // åˆ›å»ºè®¡åˆ’
  document.getElementById("createForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    var name = document.getElementById("gName").value.trim();
    var target = parseFloat(document.getElementById("gTarget").value);
    var months = parseInt(document.getElementById("gMonths").value);
    var type = document.getElementById("gType").value;
    
    if (!name || !target || !months) {
      alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
      return;
    }
    
    var data = loadData();
    var g = {
      id: genId(),
      name: name,
      target: target,
      months: months,
      monthly: (target / months).toFixed(2),
      type: type,
      owner: getUser(),
      members: [],
      createdAt: new Date().toISOString()
    };
    
    data.goals.push(g);
    if (!saveData(data)) return;
    
    this.reset();
    render();
    
    if (type === "family") {
      alert("âœ… å®¶åº­è®¡åˆ’åˆ›å»ºæˆåŠŸï¼ç‚¹å‡»è®¡åˆ’ä¸Šçš„\"é‚€è¯·\"æŒ‰é’®æ·»åŠ æˆå‘˜");
    } else {
      alert("âœ… ç§äººè®¡åˆ’åˆ›å»ºæˆåŠŸï¼");
    }
  });
  
  // å­˜å…¥
  document.getElementById("depositForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    var gid = document.getElementById("dGoalId").value;
    var amount = parseFloat(document.getElementById("dAmount").value);
    var note = document.getElementById("dNote").value;
    
    if (!amount) {
      alert("è¯·è¾“å…¥é‡‘é¢");
      return;
    }
    
    var data = loadData();
    var goal = null;
    for (var gi = 0; gi < data.goals.length; gi++) {
      if (data.goals[gi].id === gid) {
        goal = data.goals[gi];
        break;
      }
    }
    
    data.records.push({
      id: genId(),
      goalId: gid,
      amount: amount,
      note: note,
      who: getUser(),
      date: new Date().toISOString()
    });
    
    saveData(data);
    closeModal("depositModal");
    this.reset();
    render();
    
    if (goal && goal.type === "family") {
      alert("âœ… å­˜å…¥æˆåŠŸï¼");
    }
  });
  
  // åŠ å…¥å®¶åº­è®¡åˆ’
  document.getElementById("joinForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    try {
      var code = document.getElementById("joinCode").value.trim();
      var share = JSON.parse(atob(code));
      
      if (share.type !== "savings_v4") {
        throw new Error("æ— æ•ˆåˆ†äº«ç ");
      }
      
      var data = loadData();
      var user = getUser();
      
      var exists = false;
      for (var ei = 0; ei < data.goals.length; ei++) {
        if (data.goals[ei].id === share.planId) {
          exists = true;
          break;
        }
      }
      
      if (exists) {
        alert("ä½ å·²ç»åœ¨è¯¥è®¡åˆ’ä¸­äº†");
        return;
      }
      
      data.goals.push({
        id: share.planId,
        name: share.name,
        target: share.target,
        months: share.months,
        monthly: share.monthly,
        type: "family",
        owner: share.owner,
        members: [user],
        joinedAt: new Date().toISOString()
      });
      
      saveData(data);
      closeModal("joinModal");
      this.reset();
      render();
      alert("âœ… åŠ å…¥æˆåŠŸï¼");
      
    } catch(err) {
      alert("âŒ åŠ å…¥å¤±è´¥ï¼š" + err.message);
    }
  });
  
  // è®¾ç½®ç”¨æˆ·å
  document.getElementById("userForm").addEventListener("submit", function(e) {
    e.preventDefault();
    setUser(document.getElementById("userNameInput").value.trim() || "æˆ‘");
    closeModal("userModal");
    render();
  });
  
  // å¤åˆ¶é‚€è¯·ç 
  document.getElementById("copyInviteBtn").addEventListener("click", function() {
    var code = document.getElementById("inviteCode").textContent;
    navigator.clipboard.writeText(code).then(function() {
      alert("å·²å¤åˆ¶ï¼");
    });
  });
  
  // äº‹ä»¶å§”æ‰˜ - è®¡åˆ’å¡ç‰‡æŒ‰é’®
  document.getElementById("goalsList").addEventListener("click", function(e) {
    var btn = e.target.closest("button");
    if (!btn) return;
    
    var gid = btn.dataset.goalId;
    var gname = btn.dataset.goalName;
    
    if (btn.classList.contains("action-deposit")) {
      document.getElementById("dGoalId").value = gid;
      document.getElementById("dGoalName").value = gname;
      showModal("depositModal");
    } else if (btn.classList.contains("action-invite")) {
      var data = loadData();
      var goal = null;
      for (var fi = 0; fi < data.goals.length; fi++) {
        if (data.goals[fi].id === gid) {
          goal = data.goals[fi];
          break;
        }
      }
      if (!goal) return;
      
      currentInviteGoalId = gid;
      var share = {
        type: "savings_v4",
        version: 4,
        planId: goal.id,
        name: goal.name,
        target: goal.target,
        months: goal.months,
        monthly: goal.monthly,
        owner: goal.owner
      };
      document.getElementById("inviteCode").textContent = btoa(JSON.stringify(share));
      showModal("inviteModal");
    } else if (btn.classList.contains("action-delete")) {
      if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’ï¼Ÿ")) return;
      var d = loadData();
      var newGoals = [];
      for (var di = 0; di < d.goals.length; di++) {
        if (d.goals[di].id !== gid) {
          newGoals.push(d.goals[di]);
        }
      }
      d.goals = newGoals;
      var newRecords = [];
      for (var ri = 0; ri < d.records.length; ri++) {
        if (d.records[ri].goalId !== gid) {
          newRecords.push(d.records[ri]);
        }
      }
      d.records = newRecords;
      saveData(d);
      render();
    }
  });
  
  // é¡¶éƒ¨æŒ‰é’®
  document.getElementById("renameLink").addEventListener("click", function() {
    document.getElementById("userNameInput").value = getUser();
    showModal("userModal");
  });
  
  document.getElementById("joinBtn").addEventListener("click", function() {
    showModal("joinModal");
  });
  
  // å…³é—­å¼¹çª—æŒ‰é’®
  var closeBtns = document.querySelectorAll("[data-close]");
  for (var cbi = 0; cbi < closeBtns.length; cbi++) {
    closeBtns[cbi].addEventListener("click", function() {
      closeModal(this.dataset.close);
    });
  }
  
  // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
  var modals = document.querySelectorAll(".modal");
  for (var mi = 0; mi < modals.length; mi++) {
    modals[mi].addEventListener("click", function(e) {
      if (e.target === this) {
        closeModal(this.id);
      }
    });
  }
  
  // åˆå§‹åŒ–æ¸²æŸ“
  render();
  console.log("åˆå§‹åŒ–å®Œæˆ");
});
</script>
</body>
</html>
