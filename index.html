<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’µ å­˜é’±å°å·¥å…· - å®Œç¾ç‰ˆ</title>
<meta name="theme-color" content="#1b5e20">
<link rel="manifest" href="manifest.json">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #388e3c 100%);
  background-attachment: fixed;
  min-height: 100vh; color: #333; line-height: 1.6;
}
.container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }

/* Header */
.header { text-align: center; padding: 30px 20px; }
.header h1 { color: white; font-size: 2.2rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.header p { color: rgba(255,255,255,0.8); margin-top: 8px; }

/* Status Bar */
.status-bar {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 12px 20px;
  border-radius: 50px;
  margin-bottom: 20px;
  color: white;
  font-size: 0.9rem;
  text-align: center;
}
.status-bar.online { background: rgba(76, 175, 80, 0.4); }
.status-bar.offline { background: rgba(255, 100, 100, 0.3); }

/* User Bar */
.user-bar {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 15px 25px;
  border-radius: 50px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
  flex-wrap: wrap;
  gap: 10px;
}
.user-info { display: flex; align-items: center; gap: 12px; }
.user-avatar {
  width: 44px; height: 44px;
  background: linear-gradient(135deg, #ffd700, #ffb300);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
}
.user-name span { color: #ffd700; font-weight: 700; }
.user-actions { display: flex; gap: 10px; }
.btn-icon {
  background: rgba(255,255,255,0.2);
  border: none; color: white;
  padding: 10px 18px;
  border-radius: 25px;
  font-size: 0.9rem;
  cursor: pointer;
}
.btn-icon:hover { background: rgba(255,255,255,0.3); }

/* Stats */
.stats-grid {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 15px; margin-bottom: 20px;
}
.stat-card {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 25px;
  border-radius: 20px;
  text-align: center; color: white;
}
.stat-value { font-size: 2rem; font-weight: 700; color: #ffd700; }
.stat-label { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }

/* Cards */
.glass-card {
  background: white;
  border-radius: 20px;
  padding: 25px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
.card-header {
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 20px;
}
.card-title-icon {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, #1b5e20, #4caf50);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
}
.card-title { font-size: 1.2rem; font-weight: 700; color: #333; }

/* Form */
.form-group { margin-bottom: 18px; }
.form-label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
.form-input, .form-select {
  width: 100%; padding: 14px 18px;
  border: 2px solid #e8e8e8;
  border-radius: 12px;
  font-size: 1rem;
}
.form-input:focus, .form-select:focus {
  outline: none; border-color: #1b5e20;
  box-shadow: 0 0 0 4px rgba(27,94,32,0.1);
}
.btn {
  background: linear-gradient(135deg, #1b5e20, #4caf50);
  color: white; border: none;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 1rem; font-weight: 600;
  cursor: pointer;
  display: inline-flex; align-items: center; gap: 8px;
}
.btn:hover { opacity: 0.9; }
.btn-gold {
  background: linear-gradient(135deg, #ffd700, #ffb300);
  color: #1b5e20;
}
.btn-outline { background: white; border: 2px solid #1b5e20; color: #1b5e20; }
.btn-outline:hover { background: #1b5e20; color: white; }
.btn-danger { background: linear-gradient(135deg, #f44336, #e53935); }
.btn-small { padding: 10px 16px; font-size: 0.9rem; }

/* Tabs */
.tabs {
  display: flex; gap: 10px; margin-bottom: 20px;
  padding: 5px; background: #f5f5f5;
  border-radius: 50px;
}
.tab {
  flex: 1; padding: 12px;
  border: none; background: transparent;
  border-radius: 25px;
  font-weight: 600; color: #666;
  cursor: pointer;
}
.tab.active { background: white; color: #1b5e20; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

/* Goal Cards */
.goal-card {
  background: #f8f9fa;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 15px;
  border-left: 4px solid transparent;
}
.goal-card.private { border-left-color: #2196F3; }
.goal-card.family { border-left-color: #ff9800; background: linear-gradient(135deg, #fffde7, #fff8e1); }
.goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
.goal-title { font-size: 1.15rem; font-weight: 700; }
.badge {
  padding: 6px 12px; border-radius: 20px;
  font-size: 0.8rem; font-weight: 600;
}
.badge-private { background: #e3f2fd; color: #1976d2; }
.badge-family { background: #fff3e0; color: #f57c00; }
.badge-sync { background: #e8f5e9; color: #388e3c; margin-left: 8px; }

.members { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
.member-tag {
  padding: 6px 14px; background: white;
  border-radius: 20px; font-size: 0.85rem;
}
.member-tag.me { background: #1b5e20; color: white; }
.member-tag.owner { background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; }

.progress-bar {
  height: 12px; background: #e0e0e0;
  border-radius: 10px; overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #1b5e20, #4caf50, #ffd700);
  border-radius: 10px;
  transition: width 0.5s ease;
}
.goal-stats {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 10px; margin: 15px 0;
  padding: 15px; background: white;
  border-radius: 12px;
}
.stat-item { text-align: center; }
.stat-item-value { font-weight: 700; color: #333; font-size: 0.95rem; }
.stat-item-label { font-size: 0.75rem; color: #888; margin-top: 2px; }
.goal-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

/* Records */
.record-item {
  display: flex; align-items: center;
  padding: 15px; background: #f8f9fa;
  border-radius: 12px;
  margin-bottom: 10px;
  border-left: 3px solid #4caf50;
}
.record-icon {
  width: 48px; height: 48px;
  background: linear-gradient(135deg, #1b5e20, #4caf50);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; margin-right: 15px;
}
.record-amount { font-size: 1.1rem; font-weight: 700; color: #1b5e20; }
.record-meta { font-size: 0.85rem; color: #888; margin-top: 3px; }
.record-date { margin-left: auto; font-size: 0.8rem; color: #aaa; }

/* Empty State */
.empty-state { text-align: center; padding: 40px; color: #999; }
.empty-state-icon { font-size: 3rem; margin-bottom: 10px; }

/* Modal */
.modal {
  display: none; position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(5px);
  justify-content: center; align-items: center;
  z-index: 1000; padding: 20px;
}
.modal.active { display: flex; }
.modal-content {
  background: white;
  border-radius: 20px;
  width: 100%; max-width: 450px;
  max-height: 90vh; overflow-y: auto;
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 20px 25px; border-bottom: 1px solid #e8e8e8;
}
.modal-close {
  width: 36px; height: 36px;
  border: none; background: #f5f5f5;
  border-radius: 50%; font-size: 1.5rem;
  cursor: pointer;
}
.modal-body { padding: 25px; }
.share-box {
  background: #f8f9fa; border: 2px dashed #ccc;
  border-radius: 12px;
  padding: 20px; font-family: monospace;
  font-size: 0.85rem; word-break: break-all;
  margin: 15px 0;
}

/* Toast */
.toast {
  position: fixed; bottom: 100px; left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #333; color: white;
  padding: 15px 25px; border-radius: 50px;
  font-size: 0.95rem; z-index: 2000;
  opacity: 0; transition: all 0.3s;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.version-tag {
  position: fixed; bottom: 15px; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.7);
  padding: 6px 16px; border-radius: 20px;
  font-size: 0.8rem;
}

@media (max-width: 480px) {
  .stats-grid { grid-template-columns: 1fr; }
  .goal-stats { grid-template-columns: repeat(2, 1fr); }
  .user-bar { flex-direction: column; text-align: center; }
  .user-actions { width: 100%; justify-content: center; }
}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
    <p>è®©å­˜é’±æˆä¸ºä¸€ç§äº«å—</p>
  </header>
  
  <div class="status-bar" id="statusBar">ğŸ”„ æ­£åœ¨è¿æ¥ SavingMoney...</div>
  
  <div class="user-bar">
    <div class="user-info">
      <div class="user-avatar">ğŸ‘¤</div>
      <div class="user-name">æˆ‘æ˜¯ <span id="displayName">æˆ‘</span></div>
    </div>
    <div class="user-actions">
      <button class="btn-icon" onclick="showModal('userModal')">âœï¸ æ”¹å</button>
      <button class="btn-icon" onclick="showModal('joinModal')">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
    </div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="statTotal">Â¥0</div>
      <div class="stat-label">æ€»å­˜æ¬¾</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statCount">0</div>
      <div class="stat-label">æˆ‘çš„è®¡åˆ’</div>
    </div>
  </div>
  
  <!-- æ–°å»ºè®¡åˆ’è¡¨å• -->
  <div class="glass-card" id="createPlanCard">
    <div class="card-header">
      <div class="card-title-icon">ğŸ¯</div>
      <div class="card-title">æ–°å»ºå­˜é’±è®¡åˆ’</div>
    </div>
    <form id="createForm">
      <div class="form-group">
        <label class="form-label">è®¡åˆ’åç§°</label>
        <input type="text" class="form-input" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°æ–°è½¦ã€æ—…è¡ŒåŸºé‡‘" required>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
        <div class="form-group">
          <label class="form-label">ç›®æ ‡é‡‘é¢ (Â¥)</label>
          <input type="number" class="form-input" id="gTarget" placeholder="100000" min="1" required>
        </div>
        <div class="form-group">
          <label class="form-label">è®¡åˆ’æ—¶é•¿ï¼ˆæœˆï¼‰</label>
          <input type="number" class="form-input" id="gMonths" placeholder="24" min="1" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">è®¡åˆ’ç±»å‹</label>
        <select class="form-select" id="gType">
          <option value="private">ğŸ”’ ç§äººè®¡åˆ’ - ä»…è‡ªå·±å¯è§å’Œç®¡ç†</option>
          <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’ - å¤šäººå…±äº«ï¼Œå®æ—¶åŒæ­¥</option>
        </select>
      </div>
      <button type="submit" class="btn">âœ¨ åˆ›å»ºè®¡åˆ’</button>
    </form>
  </div>
  
  <!-- è®¡åˆ’åˆ—è¡¨ -->
  <div class="glass-card">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('all')">ğŸ“‹ å…¨éƒ¨</button>
      <button class="tab" onclick="switchTab('private')">ğŸ”’ ç§äºº</button>
      <button class="tab" onclick="switchTab('family')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­</button>
    </div>
    <div id="goalsList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div>è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåœ¨ä¸Šæ–¹åˆ›å»ºä¸€ä¸ªå§ï¼</div>
      </div>
    </div>
  </div>
  
  <!-- æœ€è¿‘è®°å½• -->
  <div class="glass-card">
    <div class="card-header">
      <div class="card-title-icon">ğŸ“</div>
      <div class="card-title">æœ€è¿‘å­˜å…¥è®°å½•</div>
    </div>
    <div id="recordsList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ’°</div>
        <div>è¿˜æ²¡æœ‰è®°å½•</div>
      </div>
    </div>
  </div>
</div>

<!-- å­˜å…¥æ¨¡æ€æ¡† -->
<div class="modal" id="depositModal">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-size:1.2rem;font-weight:700">ğŸ’° å­˜å…¥é‡‘é¢</div>
      <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="depositForm">
        <input type="hidden" id="dGoalId">
        <div class="form-group">
          <label class="form-label">è®¡åˆ’åç§°</label>
          <input type="text" class="form-input" id="dGoalName" readonly style="background:#f5f5f5">
        </div>
        <div class="form-group">
          <label class="form-label">å­˜å…¥é‡‘é¢ (Â¥)</label>
          <input type="number" class="form-input" id="dAmount" placeholder="5000" min="1" required>
        </div>
        <div class="form-group">
          <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" class="form-input" id="dNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆå·¥èµ„ç»“ä½™">
        </div>
        <button type="submit" class="btn btn-gold" style="width:100%">ğŸ’¾ ç¡®è®¤å­˜å…¥</button>
      </form>
    </div>
  </div>
</div>

<!-- é‚€è¯·æ¨¡æ€æ¡† -->
<div class="modal" id="inviteModal">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-size:1.2rem;font-weight:700">ğŸ”— é‚€è¯·å®¶äººåŠ å…¥</div>
      <button class="modal-close" onclick="closeModal('inviteModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="color:#666;margin-bottom:15px">å¤åˆ¶åˆ†äº«ç ç»™å®¶äººï¼š</p>
      <div class="share-box" id="inviteCode"></div>
      <button class="btn" onclick="copyInviteCode()" style="width:100%">ğŸ“‹ å¤åˆ¶åˆ†äº«ç </button>
      <div style="margin-top:20px;padding:15px;background:#e3f2fd;border-radius:12px;font-size:0.9rem;color:#555">
        <strong>ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š</strong><br>
        1. å®¶äººç‚¹å‡»"åŠ å…¥å®¶åº­è®¡åˆ’"æŒ‰é’®<br>
        2. ç²˜è´´æ­¤åˆ†äº«ç <br>
        3. åŠ å…¥åæ•°æ®å®æ—¶åŒæ­¥
      </div>
    </div>
  </div>
</div>

<!-- åŠ å…¥å®¶åº­è®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal" id="joinModal">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-size:1.2rem;font-weight:700">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</div>
      <button class="modal-close" onclick="closeModal('joinModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="color:#666;margin-bottom:15px">ç²˜è´´å®¶äººç»™ä½ çš„åˆ†äº«ç ï¼š</p>
      <form id="joinForm">
        <div class="form-group">
          <label class="form-label">åˆ†äº«ç </label>
          <textarea class="form-input" id="joinCode" rows="4" placeholder="è¯·ç²˜è´´åˆ†äº«ç ..." required></textarea>
        </div>
        <button type="submit" class="btn" style="width:100%">ğŸš€ ç«‹å³åŠ å…¥å¹¶åŒæ­¥</button>
      </form>
    </div>
  </div>
</div>

<!-- æ”¹åæ¨¡æ€æ¡† -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-size:1.2rem;font-weight:700">âœï¸ è®¾ç½®æ˜¾ç¤ºåç§°</div>
      <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">ä½ çš„åå­—ï¼ˆä¼šæ˜¾ç¤ºåœ¨å­˜å…¥è®°å½•ä¸­ï¼‰</label>
          <input type="text" class="form-input" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸ã€å¦ˆå¦ˆã€å°æ˜" required>
        </div>
        <button type="submit" class="btn" style="width:100%">ğŸ’¾ ä¿å­˜</button>
      </form>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="version-tag">v12.0 å®Œç¾ç‰ˆ</div>

<script>
// ==================== Firebase é…ç½® ====================
// å…¨å±€å˜é‡å®šä¹‰ - å¿…é¡»åœ¨æ‰€æœ‰å‡½æ•°ä¹‹å‰å®šä¹‰
var db = null;
var syncListeners = {};
var isOnline = false;
var currentTab = 'all';
var currentUser = 'æˆ‘';

const firebaseConfig = {
  apiKey: "AIzaSyDZtyTKPzqzCmgCaPlCF9UoeLCOGs3okO4",
  authDomain: "savingmoney-6d898.firebaseapp.com",
  databaseURL: "https://savingmoney-6d898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "savingmoney-6d898",
  storageBucket: "savingmoney-6d898.firebasestorage.app",
  messagingSenderId: "364582624609",
  appId: "1:364582624609:web:f6077a7012b59f44fe7920"
};
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("Firebase initialized");
} catch(e) { console.log("Firebase init failed:", e); }

const STORAGE_KEY = "savings_v12_data";
const USER_KEY = "savings_v12_user";
const USER_ID_KEY = "savings_v12_userid";

// è·å–æˆ–åˆ›å»ºç”¨æˆ·IDï¼ˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼Œä¸éšæ”¹åæ”¹å˜ï¼‰
function getUserId() {
  let userId = localStorage.getItem(USER_ID_KEY);
  if (!userId) {
    userId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    localStorage.setItem(USER_ID_KEY, userId);
  }
  return userId;
}

// çŠ¶æ€æ›´æ–°
function updateStatus(status, msg) {
  const bar = document.getElementById("statusBar");
  bar.className = "status-bar " + status;
  bar.textContent = msg;
}

// Firebaseè¿æ¥çŠ¶æ€
if (db) {
  db.ref(".info/connected").on("value", snap => {
    isOnline = snap.val() === true;
    if (isOnline) {
      updateStatus("online", "ğŸŸ¢ å·²è¿æ¥åˆ° SavingMoney äº‘ç«¯ï¼Œæ•°æ®å®æ—¶åŒæ­¥ä¸­");
      const data = loadLocalData();
      data.goals.filter(g => g.type === "family").forEach(g => startSync(g.id));
    } else {
      updateStatus("offline", "ğŸ”´ ç¦»çº¿æ¨¡å¼ - æ•°æ®ä¿å­˜åœ¨æœ¬åœ°");
    }
  });
} else {
  updateStatus("offline", "âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨");
}

// Toastæç¤º
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 3000);
}

// æ•°æ®æ“ä½œ
function getUser() { return localStorage.getItem(USER_KEY) || "æˆ‘"; }
function setUser(name) { currentUser = name || "æˆ‘"; localStorage.setItem(USER_KEY, currentUser); }
function loadLocalData() {
  try { 
    const d = localStorage.getItem(STORAGE_KEY); 
    return d ? JSON.parse(d) : { goals: [], records: [] }; 
  } catch(e) { return { goals: [], records: [] }; }
}
function saveLocalData(data) {
  try { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
    return true; 
  } catch(e) { 
    showToast("ä¿å­˜å¤±è´¥"); 
    return false; 
  }
}

// ä¸Šä¼ åˆ°äº‘ç«¯
function uploadToCloud(goalId) {
  if (!db || !isOnline) return Promise.resolve();
  const data = loadLocalData();
  const goal = data.goals.find(g => g.id === goalId);
  const records = data.records.filter(r => r.goalId === goalId);
  if (!goal) return Promise.resolve();
  return db.ref("plans/" + goalId).set({ 
    goal: goal, 
    records: records, 
    lastUpdate: Date.now() 
  }).then(() => console.log("Uploaded:", goalId))
  .catch(err => console.log("Upload error:", err));
}

// å¼€å§‹åŒæ­¥
function startSync(goalId) {
  if (!db || syncListeners[goalId]) return;
  const ref = db.ref("plans/" + goalId);
  syncListeners[goalId] = ref.on("value", snapshot => {
    const cloud = snapshot.val();
    if (!cloud) return;
    const local = loadLocalData();
    const idx = local.goals.findIndex(g => g.id === goalId);
    if (idx >= 0) {
      local.goals[idx] = cloud.goal;
      if (cloud.records) {
        cloud.records.forEach(r => { 
          if (!local.records.find(x => x.id === r.id)) local.records.push(r); 
        });
      }
      saveLocalData(local);
      render();
      showToast("ğŸ“¥ æ•°æ®å·²åŒæ­¥æ›´æ–°");
    }
  });
}

function stopSync(goalId) {
  if (syncListeners[goalId] && db) {
    db.ref("plans/" + goalId).off("value", syncListeners[goalId]);
    delete syncListeners[goalId];
  }
}

// å·¥å…·å‡½æ•°
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 6); }
function fmtMoney(n) { return "Â¥" + parseFloat(n).toLocaleString("zh-CN", {maximumFractionDigits:0}); }
function getSaved(goalId, records) { return records.filter(r => r.goalId === goalId).reduce((s, r) => s + r.amount, 0); }

// æƒé™æ£€æŸ¥ - ä½¿ç”¨userIdè€Œä¸æ˜¯ç”¨æˆ·å
function canView(goal, userId) {
  // ç§äººè®¡åˆ’ï¼šåªæœ‰åˆ›å»ºè€…å¯è§
  if (goal.type === "private") return goal.ownerId === userId;
  // å®¶åº­è®¡åˆ’ï¼šåˆ›å»ºè€…å’Œæˆå‘˜å¯è§
  if (goal.ownerId === userId) return true;
  if (goal.memberIds && goal.memberIds.includes(userId)) return true;
  return false;
}
function isOwner(goal) { return goal.ownerId === getUserId(); }
function canDeposit(goal) { 
  // ç§äººï¼šåªæœ‰åˆ›å»ºè€…å¯å­˜å…¥
  // å®¶åº­ï¼šæ‰€æœ‰å¯è§æˆå‘˜ï¼ˆåˆ›å»ºè€…å’ŒåŠ å…¥çš„æˆå‘˜ï¼‰éƒ½å¯å­˜å…¥
  return goal.type === "private" ? isOwner(goal) : canView(goal, getUserId()); 
}
function canInvite(goal) { return goal.type === "family" && isOwner(goal); }
function canDelete(goal) { return isOwner(goal); }
function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }
function encodeShareCode(o) { return btoa(encodeURIComponent(JSON.stringify(o))); }
function decodeShareCode(c) { return JSON.parse(decodeURIComponent(atob(c))); }

// åˆ‡æ¢æ ‡ç­¾
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(t => {
    t.classList.toggle("active", t.textContent.includes(tab === 'all' ? 'å…¨éƒ¨' : tab === 'private' ? 'ç§äºº' : 'å®¶åº­'));
  });
  render();
}

// æ¸²æŸ“ä¸»å‡½æ•°
function render() {
  const data = loadLocalData();
  const userId = getUserId();
  currentUser = getUser();
  document.getElementById("displayName").textContent = currentUser;
  
  // åªæ˜¾ç¤ºå½“å‰ç”¨æˆ·æœ‰æƒé™çœ‹åˆ°çš„è®¡åˆ’ï¼ˆä½¿ç”¨userIdæ£€æŸ¥ï¼‰
  const myGoals = data.goals.filter(g => canView(g, userId));
  const total = myGoals.reduce((s, g) => s + getSaved(g.id, data.records), 0);
  document.getElementById("statTotal").textContent = fmtMoney(total);
  document.getElementById("statCount").textContent = myGoals.length;
  
  // æŒ‰æ ‡ç­¾è¿‡æ»¤
  let visible = myGoals;
  if (currentTab === "private") visible = myGoals.filter(g => g.type === "private");
  if (currentTab === "family") visible = myGoals.filter(g => g.type === "family");
  
  // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨
  const list = document.getElementById("goalsList");
  if (visible.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåœ¨ä¸Šæ–¹åˆ›å»ºä¸€ä¸ªå§ï¼</div></div>';
  } else {
    list.innerHTML = visible.map(g => {
      const saved = getSaved(g.id, data.records);
      const pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
      const isDone = saved >= g.target;
      const isFamily = g.type === "family";
      const isSyncing = !!syncListeners[g.id];
      
      // æ„å»ºæˆå‘˜åˆ—è¡¨
      let members = [];
      if (isFamily) {
        members = [g.owner];
        if (g.members) g.members.forEach(m => { if (m !== g.owner) members.push(m); });
      }
      
      let html = '<div class="goal-card ' + (isFamily ? 'family' : 'private') + '">';
      html += '<div class="goal-header">';
      html += '<div class="goal-title">' + escapeHtml(g.name) + '</div>';
      html += '<div>';
      html += '<span class="badge ' + (isFamily ? 'badge-family' : 'badge-private') + '">';
      html += isFamily ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­' : 'ğŸ”’ ç§äºº';
      html += '</span>';
      if (isFamily && isSyncing) html += '<span class="badge badge-sync">ğŸ”„ åŒæ­¥</span>';
      html += '</div></div>';
      
      // æˆå‘˜æ˜¾ç¤º
      if (isFamily && members.length > 0) {
        html += '<div class="members">';
        members.forEach(m => {
          const isMe = m === currentUser;
          const isOwn = m === g.owner;
          html += '<span class="member-tag ' + (isMe ? 'me' : '') + ' ' + (isOwn ? 'owner' : '') + '">';
          html += isMe ? 'ğŸ‘¤ æˆ‘' : 'ğŸ‘¤ ' + escapeHtml(m);
          if (isOwn) html += ' ğŸ‘‘';
          html += '</span>';
        });
        html += '</div>';
      }
      
      // è¿›åº¦æ¡
      html += '<div style="margin:15px 0">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.9rem;color:#666">';
      html += '<span>è¿›åº¦ ' + pct + '%</span><span>' + (isDone ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­') + '</span>';
      html += '</div>';
      html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
      html += '</div>';
      
      // ç»Ÿè®¡æ•°æ®
      html += '<div class="goal-stats">';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(g.target) + '</div><div class="stat-item-label">ç›®æ ‡</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(saved) + '</div><div class="stat-item-label">å·²å­˜</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(Math.max(0, g.target - saved)) + '</div><div class="stat-item-label">å‰©ä½™</div></div>';
      html += '<div class="stat-item"><div class="stat-item-value">' + fmtMoney(parseFloat(g.monthly)) + '</div><div class="stat-item-label">æ¯æœˆ</div></div>';
      html += '</div>';
      
      // æ“ä½œæŒ‰é’®
      html += '<div class="goal-actions">';
      
      // å­˜å…¥æŒ‰é’® - æ‰€æœ‰å¯è§æˆå‘˜éƒ½å¯ä»¥å­˜å…¥
      if (canDeposit(g)) {
        html += '<button type="button" class="btn btn-gold btn-small" onclick="openDeposit(\'' + g.id + '\',\'' + escapeHtml(g.name) + '\')">ğŸ’° å­˜å…¥</button>';
      }
      
      // é‚€è¯·æŒ‰é’® - åªæœ‰åˆ›å»ºè€…å¯ä»¥é‚€è¯·
      if (canInvite(g)) {
        html += '<button type="button" class="btn btn-outline btn-small" onclick="openInvite(\'' + g.id + '\')">ğŸ”— é‚€è¯·</button>';
      }
      
      // åˆ é™¤æŒ‰é’® - åªæœ‰åˆ›å»ºè€…å¯ä»¥åˆ é™¤
      if (canDelete(g)) {
        html += '<button type="button" class="btn btn-danger btn-small" onclick="deleteGoal(\'' + g.id + '\')">ğŸ—‘ï¸ åˆ é™¤</button>';
      }
      
      html += '</div></div>';
      return html;
    }).join('');
  }
  
  // æ¸²æŸ“è®°å½•
  const vids = myGoals.map(g => g.id);
  const recs = data.records.filter(r => vids.includes(r.goalId)).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
  const rlist = document.getElementById("recordsList");
  if (recs.length === 0) {
    rlist.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’°</div><div>è¿˜æ²¡æœ‰è®°å½•</div></div>';
  } else {
    rlist.innerHTML = recs.map(r => {
      const goal = data.goals.find(g => g.id === r.goalId);
      return '<div class="record-item"><div class="record-icon">ğŸ’µ</div><div style="flex:1"><div class="record-amount">+' + fmtMoney(r.amount) + '</div><div class="record-meta">' + (goal ? escapeHtml(goal.name) : '') + ' Â· ' + (r.who || 'æˆ‘') + (r.note ? ' Â· ' + escapeHtml(r.note) : '') + '</div></div><div class="record-date">' + r.date.slice(0, 10) + '</div></div>';
    }).join('');
  }
}

// æ‰“å¼€å­˜å…¥å¼¹çª—
function openDeposit(gid, gname) {
  document.getElementById("dGoalId").value = gid;
  document.getElementById("dGoalName").value = gname;
  document.getElementById("dAmount").value = "";
  document.getElementById("dNote").value = "";
  showModal("depositModal");
}

// æ‰“å¼€é‚€è¯·å¼¹çª—
function openInvite(gid) {
  const data = loadLocalData();
  const goal = data.goals.find(g => g.id === gid);
  if (!goal) { showToast("æ‰¾ä¸åˆ°è¯¥è®¡åˆ’"); return; }
  
  const share = {
    type: "savings_v4",
    version: 4,
    planId: goal.id,
    name: goal.name,
    target: goal.target,
    months: goal.months,
    monthly: goal.monthly,
    ownerId: goal.ownerId,
    owner: goal.owner
  };
  
  try {
    const code = encodeShareCode(share);
    document.getElementById("inviteCode").textContent = code;
    showModal("inviteModal");
  } catch (err) {
    showToast("ç”Ÿæˆé‚€è¯·ç å¤±è´¥ï¼š" + err.message);
  }
}

// å¤åˆ¶é‚€è¯·ç 
function copyInviteCode() {
  const code = document.getElementById("inviteCode").textContent;
  if (!code) { showToast("æ²¡æœ‰é‚€è¯·ç å¯å¤åˆ¶"); return; }
  navigator.clipboard.writeText(code).then(() => {
    showToast("âœ… é‚€è¯·ç å·²å¤åˆ¶ï¼è¯·å‘ç»™å®¶äºº");
  }).catch(() => {
    showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
  });
}

// åˆ é™¤è®¡åˆ’
function deleteGoal(gid) {
  if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
  const d = loadLocalData();
  d.goals = d.goals.filter(g => g.id !== gid);
  d.records = d.records.filter(r => r.goalId !== gid);
  saveLocalData(d);
  stopSync(gid);
  render();
  showToast("âœ… è®¡åˆ’å·²åˆ é™¤");
}

// å¼¹çª—æ§åˆ¶
function showModal(id) { document.getElementById(id).classList.add("active"); }
function closeModal(id) { document.getElementById(id).classList.remove("active"); }

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
document.addEventListener("DOMContentLoaded", function() {
  currentUser = getUser();
  document.getElementById("userNameInput").value = currentUser;
  
  // åˆ›å»ºè®¡åˆ’è¡¨å•
  document.getElementById("createForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const name = document.getElementById("gName").value.trim();
    const target = parseFloat(document.getElementById("gTarget").value);
    const months = parseInt(document.getElementById("gMonths").value);
    const type = document.getElementById("gType").value;
    
    if (!name || !target || !months) {
      showToast("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
      return;
    }
    
    const data = loadLocalData();
    const userId = getUserId();
    const g = {
      id: genId(),
      name: name,
      target: target,
      months: months,
      monthly: (target / months).toFixed(2),
      type: type,
      ownerId: userId,
      owner: currentUser,
      memberIds: [],
      members: [],
      createdAt: new Date().toISOString()
    };
    
    data.goals.push(g);
    if (!saveLocalData(data)) return;
    
    // ä¸Šä¼ åˆ°äº‘ç«¯å¹¶åŒæ­¥
    if (type === "family") {
      await uploadToCloud(g.id);
      if (isOnline) startSync(g.id);
    }
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById("gName").value = "";
    document.getElementById("gTarget").value = "";
    document.getElementById("gMonths").value = "";
    
    render();
    showToast(type === "family" ? "âœ… å®¶åº­è®¡åˆ’åˆ›å»ºæˆåŠŸï¼ç‚¹å‡»é‚€è¯·æŒ‰é’®åˆ†äº«" : "âœ… ç§äººè®¡åˆ’åˆ›å»ºæˆåŠŸï¼");
  });
  
  // å­˜å…¥è¡¨å•
  document.getElementById("depositForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const gid = document.getElementById("dGoalId").value;
    const amount = parseFloat(document.getElementById("dAmount").value);
    const note = document.getElementById("dNote").value;
    
    if (!amount || amount <= 0) {
      showToast("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
      return;
    }
    
    const data = loadLocalData();
    const goal = data.goals.find(g => g.id === gid);
    
    data.records.push({
      id: genId(),
      goalId: gid,
      amount: amount,
      note: note,
      who: currentUser,
      date: new Date().toISOString()
    });
    
    saveLocalData(data);
    
    // åŒæ­¥åˆ°äº‘ç«¯
    if (goal && goal.type === "family") {
      await uploadToCloud(gid);
    }
    
    closeModal("depositModal");
    render();
    showToast(goal && goal.type === "family" ? "âœ… å­˜å…¥æˆåŠŸï¼å·²åŒæ­¥åˆ°äº‘ç«¯" : "âœ… å­˜å…¥æˆåŠŸï¼");
  });
  
  // åŠ å…¥å®¶åº­è®¡åˆ’è¡¨å•
  document.getElementById("joinForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    try {
      const code = document.getElementById("joinCode").value.trim();
      if (!code) { showToast("è¯·è¾“å…¥åˆ†äº«ç "); return; }
      
      const share = decodeShareCode(code);
      if (share.type !== "savings_v4") throw new Error("æ— æ•ˆçš„åˆ†äº«ç æ ¼å¼");
      
      const data = loadLocalData();
      if (data.goals.find(g => g.id === share.planId)) {
        showToast("âš ï¸ ä½ å·²ç»åœ¨è¿™ä¸ªå®¶åº­è®¡åˆ’ä¸­äº†ï¼");
        return;
      }
      
      const userId = getUserId();
      
      // å…ˆæ·»åŠ è®¡åˆ’åˆ°æœ¬åœ°
      data.goals.push({
        id: share.planId,
        name: share.name,
        target: share.target,
        months: share.months,
        monthly: share.monthly,
        type: "family",
        ownerId: share.ownerId || share.owner,
        owner: share.owner,
        memberIds: [userId],
        members: [currentUser],
        joinedAt: new Date().toISOString()
      });
      
      saveLocalData(data);
      
      // å…³é”®ï¼šç«‹å³ä»äº‘ç«¯æ‹‰å–å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬å†å²è®°å½•ï¼‰
      if (isOnline && db) {
        try {
          const snapshot = await db.ref("plans/" + share.planId).once("value");
          const cloudData = snapshot.val();
          if (cloudData) {
            // æ›´æ–°è®¡åˆ’æ•°æ®
            const idx = data.goals.findIndex(g => g.id === share.planId);
            if (idx >= 0 && cloudData.goal) {
              data.goals[idx] = cloudData.goal;
              // ç¡®ä¿å½“å‰ç”¨æˆ·åœ¨æˆå‘˜åˆ—è¡¨ä¸­
              if (!data.goals[idx].memberIds) data.goals[idx].memberIds = [];
              if (!data.goals[idx].memberIds.includes(userId)) {
                data.goals[idx].memberIds.push(userId);
              }
              if (!data.goals[idx].members) data.goals[idx].members = [];
              if (!data.goals[idx].members.includes(currentUser)) {
                data.goals[idx].members.push(currentUser);
              }
            }
            // åˆå¹¶å†å²è®°å½•
            if (cloudData.records) {
              cloudData.records.forEach(r => { 
                if (!data.records.find(x => x.id === r.id)) data.records.push(r); 
              });
            }
            saveLocalData(data);
            showToast("ğŸ“¥ å·²åŒæ­¥å†å²æ•°æ®");
          }
        } catch(err) {
          console.log("æ‹‰å–å†å²æ•°æ®å¤±è´¥:", err);
        }
        // å¯åŠ¨å®æ—¶åŒæ­¥
        startSync(share.planId);
      }
      
      closeModal("joinModal");
      document.getElementById("joinCode").value = "";
      render();
      showToast("âœ… æˆåŠŸåŠ å…¥å®¶åº­è®¡åˆ’ï¼ç°åœ¨å¯ä»¥ä¸€èµ·å­˜é’±äº†");
    } catch(err) {
      showToast("âŒ åŠ å…¥å¤±è´¥ï¼š" + err.message);
    }
  });
  
  // æ”¹åè¡¨å•
  document.getElementById("userForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const name = document.getElementById("userNameInput").value.trim();
    setUser(name || "æˆ‘");
    closeModal("userModal");
    render();
    showToast("âœ… åç§°å·²æ›´æ–°ä¸ºï¼š" + (name || "æˆ‘"));
  });
  
  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
  document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", function(e) {
      if (e.target === modal) closeModal(modal.id);
    });
  });
  
  // åˆå§‹æ¸²æŸ“
  render();
});

// Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
}
</script>
</body>
</html>
