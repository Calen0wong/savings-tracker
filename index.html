<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’µ å­˜é’±å°å·¥å…· - SavingMoney</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#1b5e20,#2e7d32,#85bb65);min-height:100vh;padding:15px}
.container{max-width:800px;margin:0 auto}
h1{color:white;text-align:center;margin-bottom:10px;font-size:1.8rem}
.status-bar{background:rgba(255,255,255,0.2);padding:8px 15px;border-radius:20px;margin-bottom:15px;color:white;font-size:0.85rem;text-align:center}
.status-bar.online{background:rgba(76,175,80,0.4)}
.status-bar.offline{background:rgba(255,100,100,0.3)}
.status-bar.config{background:rgba(255,193,7,0.4)}
.user-bar{background:rgba(255,255,255,0.15);padding:12px;border-radius:25px;text-align:center;color:white;margin-bottom:15px;font-size:0.9rem}
.user-bar a{color:#ffd700;cursor:pointer;text-decoration:underline;margin:0 10px}
.btn{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:white;border:none;padding:12px 20px;border-radius:8px;font-size:1rem;cursor:pointer;display:inline-block;margin:0 5px}
.btn-gold{background:linear-gradient(135deg,#ffd700,#ffb300);color:#1b5e20;font-weight:bold}
.btn-small{padding:8px 15px;font-size:0.85rem}
.btn-outline{background:white;border:2px solid #1b5e20;color:#1b5e20}
.btn-danger{background:#f56565}
.section{background:white;border-radius:12px;padding:20px;margin-bottom:15px}
.section h2{margin-bottom:15px;color:#333;font-size:1.1rem}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:5px;color:#555;font-size:0.9rem}
input,select,textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem}
.plan-tabs{display:flex;gap:10px;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
.plan-tab{padding:8px 16px;cursor:pointer;border-radius:20px;background:#f5f5f5;color:#666}
.plan-tab.active{background:#1b5e20;color:white}
.goal-card{border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:12px}
.goal-card.private{border-left:4px solid #2196F3}
.goal-card.family{border-left:4px solid #ff9800;background:#fffde7}
.goal-header{display:flex;justify-content:space-between;margin-bottom:10px}
.goal-name{font-weight:bold;font-size:1.1rem}
.badge{padding:4px 10px;border-radius:12px;font-size:0.75rem}
.badge-private{background:#e3f2fd;color:#1976d2}
.badge-family{background:#ff9800;color:white}
.badge-sync{background:#4caf50;color:white;font-size:0.7rem;margin-left:5px}
.members{display:flex;gap:5px;margin:10px 0;flex-wrap:wrap}
.member-tag{background:#f5f5f5;padding:4px 12px;border-radius:15px;font-size:0.8rem}
.member-tag.me{background:#1b5e20;color:white}
.member-tag.owner{background:#ff9800;color:white}
.progress-bar{height:20px;background:#e8e8e8;border-radius:10px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,#1b5e20,#4caf50,#ffd700);border-radius:10px;transition:width 0.5s}
.goal-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0;font-size:0.8rem;color:#666;text-align:center}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:25px;border-radius:12px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.close-btn{font-size:1.5rem;cursor:pointer;color:#999}
.share-box{background:#f8f9fa;padding:15px;border-radius:8px;border:2px dashed #ccc;font-family:monospace;font-size:0.8rem;word-break:break-all;margin:10px 0}
.empty{text-align:center;padding:30px;color:#999}
.version-tag{position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.4);color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem}
.setup-box{background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:15px;color:#856404}
.setup-box h3{margin-bottom:10px;color:#856404}
.setup-box ol{margin-left:20px;font-size:0.9rem}
.setup-box li{margin-bottom:5px}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
<div class="status-bar" id="statusBar"><span id="statusText">ğŸ”„ æ­£åœ¨è¿æ¥ SavingMoney...</span></div>

<div id="setupGuide" style="display:none">
  <div class="setup-box">
    <h3>âš ï¸ éœ€è¦å¯ç”¨ Realtime Database</h3>
    <p>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
    <ol>
      <li>æ‰“å¼€ <a href="https://console.firebase.google.com/project/savingmoney-6d898/database" target="_blank" style="color:#1976d2">Firebase æ§åˆ¶å°</a></li>
      <li>ç‚¹å‡» "åˆ›å»ºæ•°æ®åº“"</li>
      <li>é€‰æ‹©åœ°åŒº "asia-southeast1"ï¼ˆæ–°åŠ å¡ï¼‰</li>
      <li>é€‰æ‹© "ä»¥æµ‹è¯•æ¨¡å¼å¯åŠ¨"</li>
      <li>ç‚¹å‡» "å¯ç”¨"</li>
      <li>åˆ·æ–°æ­¤é¡µé¢</li>
    </ol>
    <button class="btn" onclick="location.reload()" style="margin-top:10px;width:100%">ğŸ”„ åˆ·æ–°é¡µé¢</button>
  </div>
</div>

<div class="user-bar">æˆ‘æ˜¯: <strong id="displayName">æˆ‘</strong> <a id="renameLink">âœï¸ æ”¹å</a> <button class="btn" id="joinBtn" style="margin-left:10px">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button></div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statTotal">Â¥0</div><div class="stat-label">æ€»å­˜æ¬¾</div></div>
<div class="stat-card"><div class="stat-value" id="statCount">0</div><div class="stat-label">æˆ‘çš„è®¡åˆ’</div></div>
</div>

<div class="section">
<h2>ğŸ¯ æ–°å»ºè®¡åˆ’</h2>
<form id="createForm">
<div class="form-group"><label>è®¡åˆ’åç§°</label><input type="text" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°æ–°è½¦ã€æ—…è¡ŒåŸºé‡‘" required></div>
<div class="form-group"><label>ç›®æ ‡é‡‘é¢ (Â¥)</label><input type="number" id="gTarget" placeholder="100000" min="1" required></div>
<div class="form-group"><label>è®¡åˆ’æ—¶é•¿ï¼ˆæœˆï¼‰</label><input type="number" id="gMonths" placeholder="24" min="1" required></div>
<div class="form-group"><label>è®¡åˆ’ç±»å‹</label><select id="gType"><option value="private">ğŸ”’ ç§äººè®¡åˆ’ - ä»…è‡ªå·±å¯è§</option><option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’ - å¤šäººå…±äº«</option></select></div>
<button type="submit" class="btn">âœ¨ åˆ›å»ºè®¡åˆ’</button>
</form>
</div>

<div class="section">
<div class="plan-tabs"><div class="plan-tab active" data-tab="all">å…¨éƒ¨</div><div class="plan-tab" data-tab="private">ğŸ”’ ç§äºº</div><div class="plan-tab" data-tab="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­</div></div>
<h2>ğŸ“‹ æˆ‘çš„è®¡åˆ’</h2>
<div id="goalsList"><div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>
</div>

<div class="section">
<h2>ğŸ“ æœ€è¿‘å­˜å…¥è®°å½•</h2>
<div id="recordsList"><div class="empty">è¿˜æ²¡æœ‰è®°å½•</div></div>
</div>
</div>
<div class="version-tag">v10.0 SavingMoneyç‰ˆ</div>

<div class="modal" id="depositModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’° å­˜å…¥é‡‘é¢</h3><span class="close-btn" data-close="depositModal">&times;</span></div>
<form id="depositForm">
<input type="hidden" id="dGoalId">
<div class="form-group"><label>è®¡åˆ’åç§°</label><input type="text" id="dGoalName" readonly style="background:#f5f5f5"></div>
<div class="form-group"><label>å­˜å…¥é‡‘é¢ (Â¥)</label><input type="number" id="dAmount" placeholder="5000" min="1" required></div>
<div class="form-group"><label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="dNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆå·¥èµ„ç»“ä½™"></div>
<button type="submit" class="btn btn-gold" style="width:100%">ğŸ’¾ ç¡®è®¤å­˜å…¥</button>
</form>
</div>
</div>

<div class="modal" id="inviteModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ”— é‚€è¯·å®¶äººåŠ å…¥</h3><span class="close-btn" data-close="inviteModal">&times;</span></div>
<p style="color:#666;margin-bottom:10px">å¤åˆ¶ä»¥ä¸‹åˆ†äº«ç ç»™å®¶äººï¼š</p>
<div class="share-box" id="inviteCode"></div>
<button class="btn" id="copyInviteBtn" style="width:100%">ğŸ“‹ å¤åˆ¶åˆ†äº«ç </button>
<div style="margin-top:15px;padding:15px;background:#e3f2fd;border-radius:8px;font-size:0.85rem;color:#666">
<strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
1. å®¶äººç‚¹å‡»"åŠ å…¥å®¶åº­è®¡åˆ’"<br>
2. ç²˜è´´æ­¤åˆ†äº«ç <br>
3. åŠ å…¥åæ•°æ®å®æ—¶åŒæ­¥
</div>
</div>
</div>

<div class="modal" id="joinModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</h3><span class="close-btn" data-close="joinModal">&times;</span></div>
<p style="color:#666;margin-bottom:10px">ç²˜è´´å®¶äººç»™ä½ çš„åˆ†äº«ç ï¼š</p>
<form id="joinForm">
<div class="form-group"><label>åˆ†äº«ç </label><textarea id="joinCode" rows="4" placeholder="è¯·ç²˜è´´åˆ†äº«ç ..." required></textarea></div>
<button type="submit" class="btn" style="width:100%">ğŸš€ ç«‹å³åŠ å…¥å¹¶åŒæ­¥</button>
</form>
</div>
</div>

<div class="modal" id="userModal">
<div class="modal-content">
<div class="modal-header"><h3>âœï¸ è®¾ç½®æ˜¾ç¤ºåç§°</h3><span class="close-btn" data-close="userModal">&times;</span></div>
<form id="userForm">
<div class="form-group"><label>ä½ çš„åå­—ï¼ˆä¼šæ˜¾ç¤ºåœ¨å­˜å…¥è®°å½•ä¸­ï¼‰</label><input type="text" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸ã€å¦ˆå¦ˆ" required></div>
<button type="submit" class="btn" style="width:100%">ğŸ’¾ ä¿å­˜</button>
</form>
</div>
</div>

<script>
// ==================== Firebase é…ç½® - SavingMoney ====================
const firebaseConfig = {
  apiKey: "AIzaSyDZtyTKPzqzCmgCaPlCF9UoeLCOGs3okO4",
  authDomain: "savingmoney-6d898.firebaseapp.com",
  databaseURL: "https://savingmoney-6d898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "savingmoney-6d898",
  storageBucket: "savingmoney-6d898.firebasestorage.app",
  messagingSenderId: "364582624609",
  appId: "1:364582624609:web:f6077a7012b59f44fe7920",
  measurementId: "G-C891XVRC4N"
};

let db = null;
let syncListeners = {};
let isOnline = false;

// åˆå§‹åŒ– Firebase
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
} catch(e) {
  console.log("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", e.message);
}

const STORAGE_KEY = "savings_savingmoney_v10";
const USER_KEY = "savings_savingmoney_user";
let currentTab = "all";
let currentUser = "æˆ‘";

// æ›´æ–°çŠ¶æ€
function updateStatus(status, message) {
  const bar = document.getElementById("statusBar");
  const text = document.getElementById("statusText");
  bar.className = "status-bar " + status;
  text.innerHTML = message;
}

// æ£€æŸ¥ Firebase è¿æ¥
if (db) {
  // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯è®¿é—®
  db.ref(".info/connected").on("value", (snap) => {
    isOnline = snap.val() === true;
    if (isOnline) {
      updateStatus("online", "ğŸŸ¢ å·²è¿æ¥åˆ° SavingMoney äº‘ç«¯ï¼Œæ•°æ®å®æ—¶åŒæ­¥ä¸­");
      document.getElementById("setupGuide").style.display = "none";
      // å¯åŠ¨æ‰€æœ‰å®¶åº­è®¡åˆ’çš„åŒæ­¥
      const data = loadLocalData();
      data.goals.filter(g => g.type === "family").forEach(g => startSync(g.id));
    } else {
      updateStatus("offline", "ğŸ”´ ç¦»çº¿æ¨¡å¼ - æ•°æ®ä¿å­˜åœ¨æœ¬åœ°");
    }
  }, (err) => {
    console.log("è¿æ¥é”™è¯¯:", err);
    updateStatus("config", "âš ï¸ éœ€è¦å¯ç”¨ Realtime Database");
    document.getElementById("setupGuide").style.display = "block";
  });
} else {
  updateStatus("offline", "âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨");
}

// ==================== æ•°æ®ç®¡ç† ====================
function getUser() {
  return localStorage.getItem(USER_KEY) || "æˆ‘";
}

function setUser(name) {
  currentUser = name || "æˆ‘";
  localStorage.setItem(USER_KEY, currentUser);
}

function loadLocalData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    return d ? JSON.parse(d) : { goals: [], records: [] };
  } catch(e) {
    return { goals: [], records: [] };
  }
}

function saveLocalData(data) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch(e) {
    alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + e.message);
    return false;
  }
}

// ä¸Šä¼ åˆ°äº‘ç«¯
function uploadToCloud(goalId) {
  if (!db || !isOnline) return Promise.resolve();
  
  const data = loadLocalData();
  const goal = data.goals.find(g => g.id === goalId);
  const records = data.records.filter(r => r.goalId === goalId);
  
  if (!goal) return Promise.resolve();
  
  return db.ref("plans/" + goalId).set({
    goal: goal,
    records: records,
    lastUpdate: Date.now()
  }).then(() => {
    console.log("â˜ï¸ å·²ä¸Šä¼ åˆ° SavingMoney:", goalId);
  }).catch(err => {
    console.log("âŒ ä¸Šä¼ å¤±è´¥:", err.message);
  });
}

// å¼€å§‹åŒæ­¥
function startSync(goalId) {
  if (!db || syncListeners[goalId]) return;
  
  console.log("ğŸ”„ å¼€å§‹åŒæ­¥:", goalId);
  const ref = db.ref("plans/" + goalId);
  
  syncListeners[goalId] = ref.on("value", (snapshot) => {
    const cloudData = snapshot.val();
    if (!cloudData) return;
    
    const localData = loadLocalData();
    const goalIndex = localData.goals.findIndex(g => g.id === goalId);
    
    if (goalIndex >= 0) {
      // æ›´æ–°ç›®æ ‡æ•°æ®
      localData.goals[goalIndex] = cloudData.goal;
      
      // åˆå¹¶è®°å½•ï¼ˆäº‘ç«¯ä¼˜å…ˆï¼‰
      if (cloudData.records) {
        cloudData.records.forEach(cloudRec => {
          const exists = localData.records.find(r => r.id === cloudRec.id);
          if (!exists) {
            localData.records.push(cloudRec);
          }
        });
      }
      
      saveLocalData(localData);
      render();
      console.log("ğŸ“¥ å·²ä» SavingMoney åŒæ­¥:", goalId);
    }
  }, (err) => {
    console.log("åŒæ­¥é”™è¯¯:", err);
  });
}

function stopSync(goalId) {
  if (syncListeners[goalId] && db) {
    db.ref("plans/" + goalId).off("value", syncListeners[goalId]);
    delete syncListeners[goalId];
  }
}

// ==================== å·¥å…·å‡½æ•° ====================
function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

function fmtMoney(n) {
  return "Â¥" + parseFloat(n).toLocaleString("zh-CN", { maximumFractionDigits: 0 });
}

function getSaved(goalId, records) {
  return records.filter(r => r.goalId === goalId).reduce((s, r) => s + r.amount, 0);
}

function canView(goal, user) {
  if (goal.type === "private") return goal.owner === user;
  if (goal.owner === user) return true;
  if (goal.members && goal.members.includes(user)) return true;
  return false;
}

function isOwner(goal) {
  return goal.owner === currentUser;
}

function canDeposit(goal) {
  if (goal.type === "private") return goal.owner === currentUser;
  return canView(goal, currentUser);
}

function canInvite(goal) {
  return goal.type === "family" && isOwner(goal);
}

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function encodeShareCode(obj) {
  return btoa(encodeURIComponent(JSON.stringify(obj)));
}

function decodeShareCode(code) {
  return JSON.parse(decodeURIComponent(atob(code)));
}

// ==================== æ¸²æŸ“ ====================
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".plan-tab").forEach(t => {
    t.classList.toggle("active", t.dataset.tab === tab);
  });
  const titles = { all: "ğŸ“‹ å…¨éƒ¨è®¡åˆ’", private: "ğŸ”’ ç§äººè®¡åˆ’", family: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’" };
  document.getElementById("planTitle").textContent = titles[tab];
  render();
}

function render() {
  const data = loadLocalData();
  currentUser = getUser();
  
  document.getElementById("displayName").textContent = currentUser;
  
  // ç­›é€‰å¯è§çš„è®¡åˆ’
  const myGoals = data.goals.filter(g => canView(g, currentUser));
  
  // ç»Ÿè®¡
  const total = myGoals.reduce((s, g) => s + getSaved(g.id, data.records), 0);
  document.getElementById("statTotal").textContent = fmtMoney(total);
  document.getElementById("statCount").textContent = myGoals.length;
  
  // æŒ‰Tabè¿‡æ»¤
  let visible = myGoals;
  if (currentTab === "private") visible = myGoals.filter(g => g.type === "private");
  if (currentTab === "family") visible = myGoals.filter(g => g.type === "family");
  
  // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨
  const list = document.getElementById("goalsList");
  if (visible.length === 0) {
    list.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
  } else {
    list.innerHTML = visible.map(g => {
      const saved = getSaved(g.id, data.records);
      const pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
      const isDone = saved >= g.target;
      const isFamily = g.type === "family";
      const isSyncing = !!syncListeners[g.id];
      
      // æ„å»ºæˆå‘˜åˆ—è¡¨
      let members = [];
      if (isFamily) {
        members = [g.owner || "æˆ‘"];
        if (g.members) {
          g.members.forEach(m => { if (m !== g.owner) members.push(m); });
        }
      }
      
      let html = `<div class="goal-card ${isFamily ? 'family' : 'private'}">`;
      html += `<div class="goal-header">`;
      html += `<span class="goal-name">${escapeHtml(g.name)}</span>`;
      html += `<span class="badge ${isFamily ? 'badge-family' : 'badge-private'}">`;
      html += isFamily ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­' : 'ğŸ”’ ç§äºº';
      if (isFamily && isSyncing) html += '<span class="badge-sync">åŒæ­¥ä¸­</span>';
      html += `</span></div>`;
      
      // æˆå‘˜åˆ—è¡¨
      if (isFamily && members.length > 0) {
        html += `<div class="members">`;
        members.forEach(m => {
          const isMe = m === currentUser;
          const isOwn = m === g.owner;
          html += `<span class="member-tag ${isMe ? 'me' : ''} ${isOwn ? 'owner' : ''}">`;
          html += isMe ? 'æˆ‘' : escapeHtml(m);
          if (isOwn) html += ' ğŸ‘‘';
          html += `</span>`;
        });
        html += `</div>`;
      }
      
      // ç»Ÿè®¡
      html += `<div class="goal-stats">`;
      html += `<div><strong>${fmtMoney(g.target)}</strong><br>ç›®æ ‡</div>`;
      html += `<div><strong>${fmtMoney(saved)}</strong><br>å·²å­˜</div>`;
      html += `<div><strong>${fmtMoney(Math.max(0, g.target - saved))}</strong><br>å‰©ä½™</div>`;
      html += `<div><strong>${fmtMoney(parseFloat(g.monthly))}</strong><br>æ¯æœˆ</div>`;
      html += `</div>`;
      
      // è¿›åº¦æ¡
      html += `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
      html += `<div style="text-align:center;font-size:0.9rem;color:#666;margin:5px 0">${pct}% ${isDone ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}</div>`;
      
      // æ“ä½œæŒ‰é’®
      html += `<div class="actions">`;
      if (canDeposit(g)) {
        html += `<button type="button" class="btn btn-gold btn-small btn-deposit" data-id="${g.id}" data-name="${escapeHtml(g.name)}">ğŸ’° å­˜å…¥</button>`;
      }
      if (canInvite(g)) {
        html += `<button type="button" class="btn btn-outline btn-small btn-invite" data-id="${g.id}">ğŸ”— é‚€è¯·</button>`;
      }
      if (isOwner(g)) {
        html += `<button type="button" class="btn btn-danger btn-small btn-delete" data-id="${g.id}">ğŸ—‘ï¸ åˆ é™¤</button>`;
      }
      html += `</div></div>`;
      
      return html;
    }).join('');
  }
  
  // æ¸²æŸ“è®°å½•
  const vids = myGoals.map(g => g.id);
  const recs = data.records
    .filter(r => vids.includes(r.goalId))
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 20);
  
  const rlist = document.getElementById("recordsList");
  if (recs.length === 0) {
    rlist.innerHTML = '<div class="empty">è¿˜æ²¡æœ‰è®°å½•</div>';
  } else {
    rlist.innerHTML = recs.map(r => {
      const goal = data.goals.find(g => g.id === r.goalId);
      return `
        <div class="record-item">
          <div style="display:flex;justify-content:space-between">
            <span><strong style="color:#1b5e20">+${fmtMoney(r.amount)}</strong> ${goal ? escapeHtml(goal.name) : ''}</span>
            <span style="color:#999;font-size:0.8rem">${r.date.slice(0, 10)}</span>
          </div>
          <div style="font-size:0.85rem;color:#666">
            ${r.who || 'æˆ‘'} å­˜å…¥${r.note ? ' Â· ' + escapeHtml(r.note) : ''}
          </div>
        </div>
      `;
    }).join('');
  }
}

function showModal(id) {
  document.getElementById(id).classList.add("active");
}

function closeModal(id) {
  document.getElementById(id).classList.remove("active");
}

// ==================== åˆå§‹åŒ– ====================
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸš€ SavingMoney å¯åŠ¨...");
  currentUser = getUser();
  
  // Tabåˆ‡æ¢
  document.querySelectorAll(".plan-tab").forEach(tab => {
    tab.addEventListener("click", () => switchTab(tab.dataset.tab));
  });
  
  // åˆ›å»ºè®¡åˆ’
  document.getElementById("createForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const name = document.getElementById("gName").value.trim();
    const target = parseFloat(document.getElementById("gTarget").value);
    const months = parseInt(document.getElementById("gMonths").value);
    const type = document.getElementById("gType").value;
    
    if (!name || !target || !months) {
      alert("âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
      return;
    }
    
    const data = loadLocalData();
    const g = {
      id: genId(),
      name: name,
      target: target,
      months: months,
      monthly: (target / months).toFixed(2),
      type: type,
      owner: currentUser,
      members: [],
      createdAt: new Date().toISOString()
    };
    
    data.goals.push(g);
    if (!saveLocalData(data)) return;
    
    // å¦‚æœæ˜¯å®¶åº­è®¡åˆ’ä¸”åœ¨çº¿ï¼Œä¸Šä¼ åˆ°äº‘ç«¯
    if (type === "family" && isOnline) {
      await uploadToCloud(g.id);
      startSync(g.id);
    }
    
    e.target.reset();
    render();
    
    if (type === "family") {
      alert(`âœ… å®¶åº­è®¡åˆ’ã€Œ${name}ã€åˆ›å»ºæˆåŠŸï¼\n\nç‚¹å‡»è®¡åˆ’å¡ç‰‡ä¸Šçš„ã€é‚€è¯·ã€‘æŒ‰é’®ï¼Œåˆ†äº«é‚€è¯·ç ç»™å®¶äººã€‚`);
    } else {
      alert(`âœ… ç§äººè®¡åˆ’ã€Œ${name}ã€åˆ›å»ºæˆåŠŸï¼`);
    }
  });
  
  // å­˜å…¥
  document.getElementById("depositForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const gid = document.getElementById("dGoalId").value;
    const amount = parseFloat(document.getElementById("dAmount").value);
    const note = document.getElementById("dNote").value;
    
    if (!amount || amount <= 0) {
      alert("âŒ è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
      return;
    }
    
    const data = loadLocalData();
    const goal = data.goals.find(g => g.id === gid);
    
    data.records.push({
      id: genId(),
      goalId: gid,
      amount: amount,
      note: note,
      who: currentUser,
      date: new Date().toISOString()
    });
    
    saveLocalData(data);
    
    if (goal && goal.type === "family" && isOnline) {
      await uploadToCloud(gid);
    }
    
    closeModal("depositModal");
    e.target.reset();
    render();
    
    let msg = "âœ… å­˜å…¥æˆåŠŸï¼";
    if (goal && goal.type === "family") {
      msg += "\n\nå·²åŒæ­¥åˆ° SavingMoneyï¼Œå…¶ä»–æˆå‘˜åˆ·æ–°åå¯è§ã€‚";
    }
    alert(msg);
  });
  
  // åŠ å…¥å®¶åº­è®¡åˆ’
  document.getElementById("joinForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    try {
      const code = document.getElementById("joinCode").value.trim();
      if (!code) {
        alert("è¯·è¾“å…¥åˆ†äº«ç ");
        return;
      }
      
      const share = decodeShareCode(code);
      
      if (share.type !== "savings_v4") {
        throw new Error("æ— æ•ˆçš„åˆ†äº«ç æ ¼å¼");
      }
      
      const data = loadLocalData();
      
      if (data.goals.find(g => g.id === share.planId)) {
        alert("âš ï¸ ä½ å·²ç»åœ¨è¿™ä¸ªå®¶åº­è®¡åˆ’ä¸­äº†ï¼");
        return;
      }
      
      data.goals.push({
        id: share.planId,
        name: share.name,
        target: share.target,
        months: share.months,
        monthly: share.monthly,
        type: "family",
        owner: share.owner,
        members: [currentUser],
        joinedAt: new Date().toISOString()
      });
      
      saveLocalData(data);
      
      if (isOnline) {
        await uploadToCloud(share.planId);
        startSync(share.planId);
      }
      
      closeModal("joinModal");
      e.target.reset();
      render();
      alert("âœ… æˆåŠŸåŠ å…¥å®¶åº­è®¡åˆ’ï¼\n\nç°åœ¨ä½ å¯ä»¥ï¼š\n1. æŸ¥çœ‹è¿™ä¸ªè®¡åˆ’\n2. ç‚¹å‡»ã€å­˜å…¥ã€‘æŒ‰é’®å­˜é’±\n3. æ‰€æœ‰æˆå‘˜å…±äº«æ•°æ®ï¼Œå®æ—¶åŒæ­¥");
      
    } catch(err) {
      alert("âŒ åŠ å…¥å¤±è´¥ï¼š" + err.message);
    }
  });
  
  // è®¾ç½®ç”¨æˆ·å
  document.getElementById("userForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const name = document.getElementById("userNameInput").value.trim();
    setUser(name || "æˆ‘");
    closeModal("userModal");
    render();
    alert("âœ… åç§°å·²æ›´æ–°ä¸ºï¼š" + (name || "æˆ‘"));
  });
  
  // å¤åˆ¶é‚€è¯·ç 
  document.getElementById("copyInviteBtn").addEventListener("click", () => {
    const code = document
.getElementById("inviteCode").textContent;
    if (!code) {
      alert("æ²¡æœ‰é‚€è¯·ç å¯å¤åˆ¶");
      return;
    }
    navigator.clipboard.writeText(code).then(() => {
      alert("âœ… é‚€è¯·ç å·²å¤åˆ¶ï¼\n\nè¯·å‘ç»™å®¶äººï¼Œè®©ä»–ä»¬ç‚¹å‡»ã€åŠ å…¥å®¶åº­è®¡åˆ’ã€‘æŒ‰é’®ç²˜è´´åŠ å…¥ã€‚");
    }).catch(() => {
      alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
    });
  });
  
  // äº‹ä»¶å§”æ‰˜ - è®¡åˆ’å¡ç‰‡æŒ‰é’®
  document.getElementById("goalsList").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    
    const gid = btn.dataset.id;
    if (!gid) return;
    
    if (btn.classList.contains("btn-deposit")) {
      const gname = btn.dataset.name;
      document.getElementById("dGoalId").value = gid;
      document.getElementById("dGoalName").value = gname;
      showModal("depositModal");
    } else if (btn.classList.contains("btn-invite")) {
      const data = loadLocalData();
      const goal = data.goals.find(g => g.id === gid);
      if (!goal) {
        alert("æ‰¾ä¸åˆ°è¯¥è®¡åˆ’");
        return;
      }
      
      const share = {
        type: "savings_v4",
        version: 4,
        planId: goal.id,
        name: goal.name,
        target: goal.target,
        months: goal.months,
        monthly: goal.monthly,
        owner: goal.owner
      };
      
      try {
        const code = encodeShareCode(share);
        document.getElementById("inviteCode").textContent = code;
        showModal("inviteModal");
      } catch (err) {
        alert("ç”Ÿæˆé‚€è¯·ç å¤±è´¥ï¼š" + err.message);
      }
    } else if (btn.classList.contains("btn-delete")) {
      if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’ï¼Ÿ")) return;
      const d = loadLocalData();
      d.goals = d.goals.filter(g => g.id !== gid);
      d.records = d.records.filter(r => r.goalId !== gid);
      saveLocalData(d);
      stopSync(gid);
      render();
    }
  });
  
  // å…¶ä»–æŒ‰é’®
  document.getElementById("renameLink").addEventListener("click", () => {
    document.getElementById("userNameInput").value = currentUser;
    showModal("userModal");
  });
  
  document.getElementById("joinBtn").addEventListener("click", () => {
    showModal("joinModal");
  });
  
  // å…³é—­å¼¹çª—æŒ‰é’®
  document.querySelectorAll("[data-close]").forEach(btn => {
    btn.addEventListener("click", () => closeModal(btn.dataset.close));
  });
  
  // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
  document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal(modal.id);
    });
  });
  
  // åˆå§‹åŒ–æ¸²æŸ“
  render();
  console.log("âœ… SavingMoney åˆå§‹åŒ–å®Œæˆ");
});
</script>
</body>
</html>
