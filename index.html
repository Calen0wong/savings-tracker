<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’µ å­˜é’±å°å·¥å…· - v4.2 ç¨³å®šç‰ˆ</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#1b5e20,#2e7d32,#85bb65);min-height:100vh;padding:15px}
.container{max-width:800px;margin:0 auto}
h1{color:white;text-align:center;margin-bottom:10px}
.sync-bar{background:rgba(255,255,255,0.15);padding:10px 15px;border-radius:25px;margin-bottom:15px;color:white;font-size:0.85rem;text-align:center}
.sync-bar.active{background:rgba(76,175,80,0.3)}
.user-bar{background:rgba(255,255,255,0.15);padding:12px;border-radius:25px;text-align:center;color:white;margin-bottom:15px;font-size:0.9rem;display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px}
.user-bar a{color:#ffd700;cursor:pointer}
.btn-join{background:linear-gradient(135deg,#ff6b35,#f7931e);color:white;padding:8px 16px;border-radius:20px;font-weight:bold;border:none;cursor:pointer;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.section{background:white;border-radius:12px;padding:20px;margin-bottom:15px}
.section h2{margin-bottom:15px;color:#333;font-size:1.1rem}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
.stat-card{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:white;padding:15px;border-radius:10px;text-align:center}
.stat-value{font-size:1.5rem;font-weight:bold}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:5px;color:#555;font-size:0.9rem}
input,select,textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem}
.btn{background:linear-gradient(135deg,#1b5e20,#2e7d32);color:white;border:none;padding:12px 20px;border-radius:8px;font-size:1rem;cursor:pointer}
.btn-gold{background:linear-gradient(135deg,#ffd700,#ffb300);color:#1b5e20;font-weight:bold}
.btn-small{padding:8px 15px;font-size:0.85rem}
.btn-outline{background:white;border:2px solid #1b5e20;color:#1b5e20}
.btn-danger{background:#f56565}
.plan-tabs{display:flex;gap:10px;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
.plan-tab{padding:8px 16px;cursor:pointer;border-radius:20px;background:#f5f5f5;color:#666}
.plan-tab.active{background:#1b5e20;color:white}
.goal-card{border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:12px}
.goal-card.private{border-left:4px solid #2196F3}
.goal-card.family{border-left:4px solid #ff9800;background:#fffde7}
.goal-header{display:flex;justify-content:space-between;margin-bottom:10px}
.goal-name{font-weight:bold;font-size:1.1rem}
.badge{padding:4px 10px;border-radius:12px;font-size:0.75rem}
.badge-private{background:#e3f2fd;color:#1976d2}
.badge-family{background:#ff9800;color:white}
.members{display:flex;gap:5px;margin:10px 0;flex-wrap:wrap}
.member-tag{background:#f5f5f5;padding:4px 12px;border-radius:15px;font-size:0.8rem}
.member-tag.me{background:#1b5e20;color:white}
.progress-bar{height:20px;background:#e8e8e8;border-radius:10px;overflow:hidden;margin:10px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,#1b5e20,#4caf50,#ffd700);border-radius:10px;transition:width 0.5s}
.goal-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0;font-size:0.8rem;color:#666;text-align:center}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:25px;border-radius:12px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.close-btn{font-size:1.5rem;cursor:pointer;color:#999}
.share-box{background:#f8f9fa;padding:15px;border-radius:8px;border:2px dashed #ccc;font-family:monospace;font-size:0.8rem;word-break:break-all;margin:10px 0}
.empty{text-align:center;padding:30px;color:#999}
.version-tag{position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.4);color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ’µ å­˜é’±å°å·¥å…·</h1>
<div class="sync-bar" id="syncBar">ğŸ“± ç§äººè®¡åˆ’ä»…æœ¬æœºå­˜å‚¨ | ğŸ‘¥ å®¶åº­è®¡åˆ’å®æ—¶å…±äº«</div>
<div class="user-bar">
<span>æˆ‘æ˜¯: <strong id="displayName">æˆ‘</strong></span>
<a onclick="showUserModal()">æ”¹å</a>
<button class="btn-join" onclick="showJoinModal()">ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</button>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statTotal">Â¥0</div><div class="stat-label">æ€»å­˜æ¬¾</div></div>
<div class="stat-card"><div class="stat-value" id="statCount">0</div><div class="stat-label">æˆ‘çš„è®¡åˆ’</div></div>
</div>

<div class="section">
<h2>ğŸ¯ æ–°å»ºè®¡åˆ’</h2>
<form id="createForm" onsubmit="return handleCreate(event)">
<div class="form-group">
<label>è®¡åˆ’åç§°</label>
<input type="text" id="gName" placeholder="ä¾‹å¦‚ï¼šä¹°æ–°è½¦" required>
</div>
<div class="form-group">
<label>ç›®æ ‡é‡‘é¢ (Â¥)</label>
<input type="number" id="gTarget" placeholder="100000" min="1" required>
</div>
<div class="form-group">
<label>è®¡åˆ’æ—¶é•¿ï¼ˆæœˆï¼‰</label>
<input type="number" id="gMonths" placeholder="24" min="1" required>
</div>
<div class="form-group">
<label>è®¡åˆ’ç±»å‹</label>
<select id="gType">
<option value="private">ğŸ”’ ç§äººè®¡åˆ’ - ä»…è‡ªå·±å¯è§</option>
<option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’ - é‚€è¯·æˆå‘˜å…±äº«</option>
</select>
</div>
<button type="submit" class="btn" id="createBtn">âœ¨ åˆ›å»ºè®¡åˆ’</button>
</form>
</div>

<div class="section">
<div class="plan-tabs">
<div class="plan-tab active" onclick="switchTab('all',this)">å…¨éƒ¨</div>
<div class="plan-tab" onclick="switchTab('private',this)">ğŸ”’ ç§äºº</div>
<div class="plan-tab" onclick="switchTab('family',this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­</div>
</div>
<h2 id="planTitle">ğŸ“‹ æˆ‘çš„è®¡åˆ’</h2>
<div id="goalsList"><div class="empty">è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div></div>
</div>

<div class="section">
<h2>ğŸ“ æœ€è¿‘å­˜å…¥è®°å½•</h2>
<div id="recordsList"><div class="empty">è¿˜æ²¡æœ‰è®°å½•</div></div>
</div>
</div>
<div class="version-tag">v4.2 ç¨³å®šç‰ˆ</div>

<div class="modal" id="depositModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’° å­˜å…¥é‡‘é¢</h3><span class="close-btn" onclick="closeModal('depositModal')">&times;</span></div>
<form id="depositForm" onsubmit="return handleDeposit(event)">
<input type="hidden" id="dGoalId">
<div class="form-group"><label>è®¡åˆ’åç§°</label><input type="text" id="dGoalName" readonly style="background:#f5f5f5"></div>
<div class="form-group"><label>å­˜å…¥é‡‘é¢ (Â¥)</label><input type="number" id="dAmount" placeholder="5000" min="1" required></div>
<div class="form-group"><label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label><input type="text" id="dNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆå·¥èµ„"></div>
<button type="submit" class="btn btn-gold" style="width:100%">ç¡®è®¤å­˜å…¥</button>
</form>
</div>
</div>

<div class="modal" id="inviteModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ”— é‚€è¯·å®¶äºº</h3><span class="close-btn" onclick="closeModal('inviteModal')">&times;</span></div>
<p style="color:#666;margin-bottom:10px">å¤åˆ¶åˆ†äº«ç ç»™å®¶äººï¼š</p>
<div class="share-box" id="inviteCode"></div>
<button class="btn" onclick="copyInvite()" style="width:100%">ğŸ“‹ å¤åˆ¶</button>
</div>
</div>

<div class="modal" id="joinModal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘‹ åŠ å…¥å®¶åº­è®¡åˆ’</h3><span class="close-btn" onclick="closeModal('joinModal')">&times;</span></div>
<p style="color:#666;margin-bottom:10px">åŠ å…¥åå³å¯ä¸å®¶äººå®æ—¶å…±äº«ï¼š</p>
<form id="joinForm" onsubmit="return handleJoin(event)">
<div class="form-group"><label>ç²˜è´´åˆ†äº«ç </label><textarea id="joinCode" rows="4" placeholder="è¯·ç²˜è´´åˆ†äº«ç ..." required></textarea></div>
<button type="submit" class="btn" style="width:100%">ç«‹å³åŠ å…¥</button>
</form>
</div>
</div>

<div class="modal" id="userModal">
<div class="modal-content">
<div class="modal-header"><h3>è®¾ç½®åç§°</h3><span class="close-btn" onclick="closeModal('userModal')">&times;</span></div>
<form id="userForm" onsubmit="return handleUser(event)">
<div class="form-group"><label>ä½ çš„åå­—</label><input type="text" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šçˆ¸çˆ¸" required></div>
<button type="submit" class="btn" style="width:100%">ä¿å­˜</button>
</form>
</div>
</div>

<script>
// ========== Firebase é…ç½® ==========
const firebaseConfig = {
  apiKey: "AIzaSyDemoKey",
  authDomain: "savings-demo.firebaseapp.com",
  databaseURL: "https://savings-demo-default-rtdb.firebaseio.com",
  projectId: "savings-demo",
  storageBucket: "savings-demo.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:demo"
};

let db = null;
let syncListeners = {};

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
} catch(e) {
  console.log('Firebase åˆå§‹åŒ–å¤±è´¥:', e);
}

// ========== æ•°æ®ç®¡ç† ==========
const STORAGE_KEY = 'savings_v4_data';
const USER_KEY = 'savings_v4_user';
let currentTab = 'all';

function getUser() {
  return localStorage.getItem(USER_KEY) || 'æˆ‘';
}

function setUser(name) {
  localStorage.setItem(USER_KEY, name);
}

function loadData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    if (d) {
      return JSON.parse(d);
    }
  } catch(e) {
    console.log('è¯»å–æ•°æ®å¤±è´¥:', e);
  }
  return { goals: [], records: [] };
}

function saveData(data) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch(e) {
    console.log('ä¿å­˜æ•°æ®å¤±è´¥:', e);
    alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³');
    return false;
  }
}

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

function fmtMoney(n) {
  return 'Â¥' + parseFloat(n).toLocaleString('zh-CN', {maximumFractionDigits: 0});
}

function getSaved(goalId, records) {
  return records.filter(r => r.goalId === goalId).reduce((s, r) => s + r.amount, 0);
}

// ========== åŒæ­¥åŠŸèƒ½ ==========
function startSync(goalId) {
  if (!db || syncListeners[goalId]) return;
  
  console.log('å¼€å§‹åŒæ­¥:', goalId);
  const ref = db.ref('plans/' + goalId);
  
  syncListeners[goalId] = ref.on('value', (snapshot) => {
    const cloud = snapshot.val();
    if (!cloud) return;
    
    const local = loadData();
    const idx = local.goals.findIndex(g => g.id === goalId);
    
    if (idx >= 0) {
      // æ›´æ–°ç›®æ ‡ä¿¡æ¯
      local.goals[idx].name = cloud.goal.name;
      local.goals[idx].target = cloud.goal.target;
      local.goals[idx].months = cloud.goal.months;
      local.goals[idx].monthly = cloud.goal.monthly;
      local.goals[idx].members = cloud.goal.members || [];
      
      // åˆå¹¶è®°å½•
      if (cloud.records) {
        cloud.records.forEach(cr => {
          if (!local.records.find(r => r.id === cr.id)) {
            local.records.push(cr);
          }
        });
      }
      
      saveData(local);
      render();
      updateSyncBar();
    }
  });
  
  updateSyncBar();
}

function stopSync(goalId) {
  if (syncListeners[goalId]) {
    db.ref('plans/' + goalId).off('value', syncListeners[goalId]);
    delete syncListeners[goalId];
    updateSyncBar();
  }
}

function uploadPlan(goalId) {
  if (!db) return Promise.resolve();
  
  const data = loadData();
  const goal = data.goals.find(g => g.id === goalId);
  const recs = data.records.filter(r => r.goalId === goalId);
  
  if (!goal) return Promise.resolve();
  
  return db.ref('plans/' + goalId).set({
    goal: {...goal, lastUpdate: Date.now()},
    records: recs
  }).catch(e => {
    console.log('ä¸Šä¼ å¤±è´¥:', e);
  });
}

function updateSyncBar() {
  const count = Object.keys(syncListeners).length;
  const bar = document.getElementById('syncBar');
  if (count > 0) {
    bar.classList.add('active');
    bar.textContent = 'ğŸ”„ ' + count + 'ä¸ªå®¶åº­è®¡åˆ’åŒæ­¥ä¸­';
  } else {
    bar.classList.remove('active');
    bar.textContent = 'ğŸ“± ç§äººè®¡åˆ’ä»…æœ¬æœºå­˜å‚¨ | ğŸ‘¥ å®¶åº­è®¡åˆ’å®æ—¶å…±äº«';
  }
}

function initSync() {
  const data = loadData();
  data.goals.filter(g => g.type === 'family').forEach(g => {
    startSync(g.id);
  });
}

// ========== æƒé™ç³»ç»Ÿ ==========
function canView(goal, user) {
  if (goal.type === 'private') {
    return goal.owner === user;
  }
  if (goal.owner === user) return true;
  if (goal.members && goal.members.includes(user)) return true;
  return false;
}

function isOwner(goal) {
  return goal.owner === getUser();
}

function canDeposit(goal) {
  const user = getUser();
  if (goal.type === 'private') return goal.owner === user;
  return canView(goal, user);
}

// ========== æ¸²æŸ“ ==========
function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.plan-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  
  const titles = {all: 'ğŸ“‹ å…¨éƒ¨è®¡åˆ’', private: 'ğŸ”’ ç§äººè®¡åˆ’', family: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­è®¡åˆ’'};
  document.getElementById('planTitle').textContent = titles[tab];
  render();
}

function render() {
  const data = loadData();
  const user = getUser();
  
  document.getElementById('displayName').textContent = user;
  
  // ç»Ÿè®¡
  const myGoals = data.goals.filter(g => canView(g, user));
  const total = myGoals.reduce((s, g) => s + getSaved(g.id, data.records), 0);
  document.getElementById('statTotal').textContent = fmtMoney(total);
  document.getElementById('statCount').textContent = myGoals.length;
  
  // è¿‡æ»¤
  let visible = myGoals;
  if (currentTab === 'private') visible = myGoals.filter(g => g.type === 'private');
  if (currentTab === 'family') visible = myGoals.filter(g => g.type === 'family');
  
  // æ¸²æŸ“è®¡åˆ’
  const list = document.getElementById('goalsList');
  if (visible.length === 0) {
    list.innerHTML = '<div class="empty">æš‚æ— è®¡åˆ’</div>';
  } else {
    list.innerHTML = visible.map(g => {
      const saved = getSaved(g.id, data.records);
      const pct = Math.min(100, (saved / g.target * 100)).toFixed(1);
      const isDone = saved >= g.target;
      const isFamily = g.type === 'family';
      const syncing = !!syncListeners[g.id];
      const members = isFamily ? [g.owner || 'æˆ‘', ...(g.members || [])] : [];
      
      let html = '<div class="goal-card ' + (isFamily ? 'family' : 'private') + '">';
      html += '<div class="goal-header">';
      html += '<span class="goal-name">' + g.name + '</span>';
      html += '<span class="badge ' + (isFamily ? 'badge-family' : 'badge-private') + '">';
      html += isFamily ? (syncing ? 'ğŸ”„ ' : '') + 'å®¶åº­' : 'ç§äºº';
      html += '</span></div>';
      
      if (isFamily && members.length > 0) {
        html += '<div class="members">';
        members.forEach(m => {
          html += '<span class="member-tag ' + (m === user ? 'me' : '') + '">';
          html += (m === user ? 'æˆ‘' : m) + (m === g.owner ? ' ğŸ‘‘' : '');
          html += '</span>';
        });
        html += '</div>';
      }
      
      html += '<div class="goal-stats">';
      html += '<div><strong>' + fmtMoney(g.target) + '</strong><br>ç›®æ ‡</div>';
      html += '<div><strong>' + fmtMoney(saved) + '</strong><br>å·²å­˜</div>';
      html += '<div><strong>' + fmtMoney(Math.max(0, g.target - saved)) + '</strong><br>å‰©ä½™</div>';
      html += '<div><strong>' + fmtMoney(g.monthly) + '</strong><br>æ¯æœˆ</div>';
      html += '</div>';
      
      html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
      html += '<div style="text-align:center;font-size:0.9rem;color:#666;margin:5px 0">' + pct + '% ' + (isDone ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­') + '</div>';
      
      html += '<div class="actions">';
      if (canDeposit(g)) {
        html += '<button class="btn btn-gold btn-small" onclick="openDeposit('' + g.id + '','' + g.name + '')">å­˜å…¥</button>';
      }
      if (isFamily && isOwner(g)) {
        html += '<button class="btn btn-outline btn-small" onclick="openInvite('' + g.id + '')">é‚€è¯·</button>';
      }
      if (isOwner(g)) {
        html += '<button class="btn btn-danger btn-small" onclick="deleteGoal('' + g.id + '')">åˆ é™¤</button>';
      }
      html += '</div></div>';
      
      return html;
    }).join('');
  }
  
  // æ¸²æŸ“è®°å½•
  const vids = myGoals.map(g => g.id);
  const recs = data.records.filter(r => vids.includes(r.goalId)).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
  
  const rlist = document.getElementById('recordsList');
  if (recs.length === 0) {
    rlist.innerHTML = '<div class="empty">æš‚æ— è®°å½•</div>';
  } else {
    rlist.innerHTML = recs.map(r => {
      const g = data.goals.find(x => x.id === r.goalId);
      return '<div style="padding:10px;border-bottom:1px solid #f0f0f0">' +
        '<div style="display:flex;justify-content:space-between">' +
        '<span><strong style="color:#1b5e20">+' + fmtMoney(r.amount) + '</strong> ' + (g ? g.name : '') + '</span>' +
        '<span style="color:#999;font-size:0.8rem">' + r.date.slice(0, 10) + '</span>' +
        '</div>' +
        '<div style="font-size:0.85rem;color:#666">' + (r.who || 'æˆ‘') + ' å­˜å…¥' + (r.note ? ' Â· ' + r.note : '') + '</div>' +
        '</div>';
    }).join('');
  }
}

// ========== äº‹ä»¶å¤„ç† ==========
function handleCreate(e) {
  e.preventDefault();
  console.log('åˆ›å»ºè®¡åˆ’...');
  
  const name = document.getElementById('gName').value.trim();
  const target = parseFloat(document.getElementById('gTarget').value);
  const months = parseInt(document.getElementById('gMonths').value);
  const type = document.getElementById('gType').value;
  
  if (!name || !target || !months) {
    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
    return false;
  }
  
  const data = loadData();
  const user = getUser();
  
  const g = {
    id: genId(),
    name: name,
    target: target,
    months: months,
    monthly: (target / months).toFixed(2),
    type: type,
    owner: user,
    members: [],
    createdAt: new Date().toISOString()
  };
  
  console.log('æ–°è®¡åˆ’:', g);
  data.goals.push(g);
  
  if (!saveData(data)) {
    return false;
  }
  
  console.log('æ•°æ®å·²ä¿å­˜');
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('createForm').reset();
  
  // é‡æ–°æ¸²æŸ“
  render();
  
  // å¦‚æœæ˜¯å®¶åº­è®¡åˆ’ï¼Œå°è¯•åŒæ­¥
  if (type === 'family' && db) {
    uploadPlan(g.id);
    startSync(g.id);
    alert('âœ… å®¶åº­è®¡åˆ’åˆ›å»ºæˆåŠŸï¼');
  } else {
    alert('âœ… ç§äººè®¡åˆ’åˆ›å»ºæˆåŠŸï¼');
  }
  
  return false;
}

function handleDeposit(e) {
  e.preventDefault();
  
  const gid = document.getElementById('dGoalId').value;
  const amount = parseFloat(document.getElementById('dAmount').value);
  const note = document.getElementById('dNote').value;
  
  if (!amount || amount <= 0) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
    return false;
  }
  
  const data = loadData();
  const goal = data.goals.find(g => g.id === gid);
  
  data.records.push({
    id: genId(),
    goalId: gid,
    amount: amount,
    note: note,
    who: getUser(),
    date: new Date().toISOString()
  });
  
  saveData(data);
  
  if (goal && goal.type === 'family') {
    uploadPlan(gid);
  }
  
  closeModal('depositModal');
  document.getElementById('depositForm').reset();
  render();
  
  if (goal && goal.type === 'family') {
    alert('âœ… å­˜å…¥æˆåŠŸï¼å·²åŒæ­¥ç»™å®¶äºº');
  }
  
  return false;
}

function handleJoin(e) {
  e.preventDefault();
  
  try {
    const code = document.getElementById('joinCode').value.trim();
    const share = JSON.parse(atob(code));
    
    if (share.type !== 'savings_v4') {
      throw new Error('æ— æ•ˆåˆ†äº«ç ');
    }
    
    const data = loadData();
    const user = getUser();
    
    if (data.goals.find(g => g.id === share.planId)) {
      alert('ä½ å·²åœ¨è¯¥è®¡åˆ’ä¸­');
      return false;
    }
    
    data.goals.push({
      id: share.planId,
      name: share.name,
      target: share.target,
      months: share.months,
      monthly: share.monthly,
      type: 'family',
      owner: share.owner,
      members: [user],
      joinedAt: new Date().toISOString()
    });
    
    saveData(data);
    startSync(share.planId);
    
    closeModal('joinModal');
    document.getElementById('joinForm').reset();
    render();
    alert('âœ… åŠ å…¥æˆåŠŸï¼æ•°æ®å°†å®æ—¶åŒæ­¥');
    
  } catch (err) {
    alert('âŒ ' + err.message);
  }
  
  return false;
}

function handleUser(e) {
  e.preventDefault();
  setUser(document.getElementById('userNameInput').value.trim() || 'æˆ‘');
  closeModal('userModal');
  render();
  return false;
}

function openDeposit(gid, gname) {
  document.getElementById('dGoalId').value = gid;
  document.getElementById('dGoalName').value = gname;
  showModal('depositModal');
}

function openInvite(gid) {
  const data = loadData();
  const g = data.goals.find(x => x.id === gid);
  if (!g) return;
  
  const shareObj = {
    type: 'savings_v4',
    version: 4,
    planId: g.id,
    name: g.name,
    target: g.target,
    months: g.months,
    monthly: g.monthly,
    owner: g.owner
  };
  
  document.getElementById('inviteCode').textContent = btoa(JSON.stringify(shareObj));
  showModal('inviteModal');
}

function copyInvite() {
  navigator.clipboard.writeText(document.getElementById('inviteCode').textContent).then(() => {
    alert('å·²å¤åˆ¶ï¼');
  });
}

function deleteGoal(gid) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’ï¼Ÿ')) return;
  
  stopSync(gid);
  
  const data = loadData();
  data.goals = data.goals.filter(g => g.id !== gid);
  data.records = data.records.filter(r => r.goalId !== gid);
  saveData(data);
  render();
}

function showModal(id) {
  document.getElementById(id).classList.add('active');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function showJoinModal() {
  showModal('joinModal');
}

function showUserModal() {
  document.getElementById('userNameInput').value = getUser();
  showModal('userModal');
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
window.onclick = function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
};

// é¡µé¢åŠ è½½
window.onload = function() {
  console.log('é¡µé¢åŠ è½½ï¼Œåˆå§‹åŒ–...');
  initSync();
  render();
  console.log('åˆå§‹åŒ–å®Œæˆ');
};
</script>
</body>
</html>